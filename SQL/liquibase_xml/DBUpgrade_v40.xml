<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">


    <property name="text.type" value="varchar" dbms="mysql" />
    <property name="text.type" value="varchar2" dbms="oracle" />

    <property name="int.type" value="bigint(20)" dbms="mysql" />
    <property name="int.type" value="number(19,0)" dbms="oracle" />
    
    <property name="double.type" value="double" dbms="mysql" />
    <property name="double.type" value="double" dbms="oracle" />

    <property name="smallint.type" value="smallint" dbms="mysql" />
    <property name="smallint.type" value="number(5,0)" dbms="oracle" />

    <property name="smallint.type" value="smallint" dbms="mysql" />
    <property name="smallint.type" value="number(5,0)" dbms="oracle" />

    <property name="mediumint.type" value="int" dbms="mysql"/>
    <property name="mediumint.type" value="number(11, 0)" dbms="oracle"/>
    
    <property name="date.type" value="date" dbms="mysql" />
    <property name="date.type" value="date" dbms="oracle" />

    <property name="timestamp.type" value="timestamp" dbms="mysql" />
    <property name="timestamp.type" value="timestamp" dbms="oracle" />
    
    <property name="datetime.type" value="datetime" dbms="mysql" />
    <property name="datetime.type" value="date" dbms="oracle" />
    
    <property name="boolean.type" value="boolean" dbms="mysql" />
    <property name="boolean.type" value="number(1,0)" dbms="oracle" />
    
    <property name="boolean.true" value="true" dbms="mysql" />
    <property name="boolean.true" value="1" dbms="oracle" />
    
    <property name="boolean.false" value="false" dbms="mysql" />
    <property name="boolean.false" value="0" dbms="oracle" />

    <property name="autoIncrement" value="true" dbms="mysql"/>
    <property name="autoIncrement" value="false" dbms="oracle"/>
    
    <property name="blob.type" value="blob" dbms="mysql" />
    <property name="blob.type" value="blob" dbms="oracle" />

    <property name="clob.type" value="text" dbms="mysql"/>
    <property name="clob.type" value="clob" dbms="oracle"/>
    
 
     <changeSet id="1" author="nitesh" runOnChange="true">
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="SPECIMEN_CLASS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="SPECIMEN_TYPE" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="CONCENTRATION" type="${double.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="PARENT_SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="INITIAL_QUANTITY" type="${double.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="PATHOLOGICAL_STATUS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="LINEAGE" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="COLLECTOR_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="COLLECTION_CONTAINER" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="COLLECTION_PROCEDURE" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="COLLECTION_COMMENTS" type="${text.type}(500)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="COLLECTION_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="RECEIVER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="RECEIVED_COMMENTS" type="${text.type}(500)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="RECEIVED_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="RECEIVED_QUALITY" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="TISSUE_SITE" type="${text.type}(150)" />
        </addColumn>
        <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
            <column name="TISSUE_SIDE" type="${text.type}(50)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="2" author="nitesh" runOnChange="true">
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="SPECIMEN_CLASS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="SPECIMEN_TYPE" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="CONCENTRATION" type="${double.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="PARENT_SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="INITIAL_QUANTITY" type="${double.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="PATHOLOGICAL_STATUS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="LINEAGE" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="TISSUE_SITE" type="${text.type}(150)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN">
            <column name="TISSUE_SIDE" type="${text.type}(50)" />
        </addColumn>
    </changeSet>
    
	<changeSet author="nitesh" id="3" failOnError="false">
	    <dropForeignKeyConstraint baseTableName="CATISSUE_CP_REQ_SPECIMEN" constraintName="FK_PARENT_CP_REQ_SPECIMEN"/>
	</changeSet>
	
	<changeSet author="nitesh" id="4" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_SPECIMEN" constraintName="FK_PARENT_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="5" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_SPECIMEN_EVENT_PARAM" constraintName="FK753F33AD60773DB2"/>
    </changeSet>
    
    <changeSet id="6" author="nitesh" dbms="mysql">
        <sql>update catissue_specimen specimen join catissue_abstract_specimen aspecimen on aspecimen.identifier = specimen.identifier
            left join catissue_specimen_char sp_char on sp_char.identifier = aspecimen.SPECIMEN_CHARACTERISTICS_ID
            set specimen.PARENT_SPECIMEN_ID = aspecimen.PARENT_SPECIMEN_ID, 
            specimen.INITIAL_QUANTITY = aspecimen.INITIAL_QUANTITY,
            specimen.PATHOLOGICAL_STATUS = aspecimen.PATHOLOGICAL_STATUS,
            specimen.LINEAGE = aspecimen.LINEAGE,
            specimen.SPECIMEN_CLASS = aspecimen.SPECIMEN_CLASS,
            specimen.SPECIMEN_TYPE = aspecimen.SPECIMEN_TYPE,
            specimen.CONCENTRATION = aspecimen.CONCENTRATION, 
            specimen.tissue_side = sp_char.tissue_side, 
            specimen.tissue_site = sp_char.tissue_site
            where specimen.identifier is not null</sql>
		<sql>update catissue_cp_req_specimen specimenReq join catissue_abstract_specimen aspecimen on aspecimen.identifier = specimenReq.identifier
            left join catissue_specimen_char sp_char on sp_char.identifier = aspecimen.SPECIMEN_CHARACTERISTICS_ID
            set specimenReq.PARENT_SPECIMEN_ID = aspecimen.PARENT_SPECIMEN_ID, 
            specimenReq.INITIAL_QUANTITY = aspecimen.INITIAL_QUANTITY,
            specimenReq.PATHOLOGICAL_STATUS = aspecimen.PATHOLOGICAL_STATUS,
            specimenReq.LINEAGE = aspecimen.LINEAGE,
            specimenReq.SPECIMEN_CLASS = aspecimen.SPECIMEN_CLASS,
            specimenReq.SPECIMEN_TYPE = aspecimen.SPECIMEN_TYPE,
            specimenReq.CONCENTRATION = aspecimen.CONCENTRATION,
            specimenReq.tissue_side = sp_char.tissue_side, 
            specimenReq.tissue_site = sp_char.tissue_site
            where specimenReq.identifier is not null</sql>
		<sql>update catissue_cp_req_specimen specimenReq join catissue_specimen_event_param event on 
			event.specimen_id = specimenReq.identifier join catissue_coll_event_param collEvent on 
			collEvent.identifier = event.identifier 
			set 
			specimenReq.COLLECTION_TIMESTAMP = event.EVENT_TIMESTAMP,
			specimenReq.COLLECTION_COMMENTS = event.COMMENTS,
			specimenReq.COLLECTION_PROCEDURE = collEvent.COLLECTION_PROCEDURE,
			specimenReq.COLLECTION_CONTAINER = collEvent.CONTAINER,
			specimenReq.COLLECTOR_ID = event.USER_ID 
			where specimenReq.identifier is not null</sql>
		<sql>update catissue_cp_req_specimen specimenReq join catissue_specimen_event_param event on 
			event.specimen_id = specimenReq.identifier join catissue_received_event_param recEvent on
			recEvent.identifier = event.identifier
			set 
			specimenReq.RECEIVED_QUALITY = recEvent.RECEIVED_QUALITY,
			specimenReq.RECEIVED_TIMESTAMP = event.EVENT_TIMESTAMP,
			specimenReq.RECEIVED_COMMENTS = event.COMMENTS,
			specimenReq.RECEIVER_ID =  event.USER_ID where specimenReq.identifier is not null</sql>
		<sql>commit;</sql>
    </changeSet>
    
    <changeSet id="Delete duplicate events for specimen requirement" author="nitesh" dbms="oracle">
        <sql splitStatements="false" endDelimiter="$">
            create or replace
            PROCEDURE DEL_DUP_REQ_COLL_EVENTS 
            IS
               cnt number;
               scgId number;
               cnumber number;
               eventId number;
            BEGIN   
            for d in (select cnt, scgId from (select count(*) as cnt, event.specimen_id as scgId 
                from catissue_cp_req_specimen t2 join catissue_specimen_event_param event on 
                event.specimen_id = t2.identifier
                inner join catissue_coll_event_param collEvent on collEvent.identifier = event.identifier 
                group by event.specimen_id) t1 where t1.cnt > 1)
               loop
               cnt:=d.cnt;
                for e in (select ep.identifier as id from catissue_specimen_event_param ep join 
                            catissue_coll_event_param cep on ep.identifier = cep.identifier where ep.specimen_id = d.scgId)
                loop
                        
                    if(cnt != 1) then
                            
                        delete from catissue_coll_event_param where identifier = e.id;
                        delete from catissue_specimen_event_param where identifier = e.id;
                    end if;
                            cnt:=cnt-1;
                end loop;
                end loop;
            commit;     
            END DEL_DUP_REQ_COLL_EVENTS;
    </sql>
    <sql splitStatements="false" endDelimiter="$">
            create or replace
            PROCEDURE DEL_DUP_REQ_REC_EVENTS 
            IS
               cnt number;
               scgId number;
               cnumber number;
               eventId number;
            BEGIN   
            for d in (select cnt, scgId from (select count(*) as cnt, event.specimen_id as scgId 
                from catissue_cp_req_specimen t2 join catissue_specimen_event_param event on 
                event.specimen_id = t2.identifier
                inner join catissue_received_event_param collEvent on collEvent.identifier = event.identifier 
                group by event.specimen_id) t1 where t1.cnt > 1)
               loop
               cnt:=d.cnt;
                for e in (select ep.identifier as id from catissue_specimen_event_param ep join 
                            catissue_received_event_param cep on ep.identifier = cep.identifier where ep.specimen_id = d.scgId)
                loop
                    if(cnt != 1) then
                        delete from catissue_received_event_param where identifier = e.id;
                        delete from catissue_specimen_event_param where identifier = e.id;
                    end if;
                    cnt:=cnt-1;
                end loop;
                end loop;
            commit;   
            END DEL_DUP_REQ_REC_EVENTS;
    </sql>
    <sql>call DEL_DUP_REQ_COLL_EVENTS();</sql>
    <sql>call DEL_DUP_REQ_REC_EVENTS();</sql>
    <sql>commit;</sql>
    </changeSet>
    
    <changeSet id="7" author="nitesh" dbms="oracle">
        <sql>update (
            select specimen.PARENT_SPECIMEN_ID as sParentId, aspecimen.PARENT_SPECIMEN_ID as aParentId, 
            specimen.INITIAL_QUANTITY as sInitQty, aspecimen.INITIAL_QUANTITY as aInitQty,
            specimen.PATHOLOGICAL_STATUS as sPathStatus, aspecimen.PATHOLOGICAL_STATUS as aPathStatus,
            specimen.LINEAGE as sLineage, aspecimen.LINEAGE as aLineage,
            specimen.SPECIMEN_CLASS as sClass, aspecimen.SPECIMEN_CLASS as aClass,
            specimen.SPECIMEN_TYPE as sType, aspecimen.SPECIMEN_TYPE as aType,
            specimen.CONCENTRATION as sCon, aspecimen.CONCENTRATION as aCon, 
            specimen.tissue_side as sTissueSide, sp_char.tissue_side as sp_charTissueSide,
            specimen.tissue_site as sTissueSite, sp_char.tissue_site as sp_charTissueSite from
            catissue_specimen specimen join catissue_abstract_specimen aspecimen on aspecimen.identifier = specimen.identifier 
            left join catissue_specimen_char sp_char on sp_char.identifier = aspecimen.SPECIMEN_CHARACTERISTICS_ID
            where specimen.identifier is not null
            ) up
            set up.sParentId = up.aParentId,
            up.sInitQty = up.aInitQty,
            up.sPathStatus = up.aPathStatus,
            up.sLineage = up.aLineage,
            up.sClass = up.aClass,
            up.sType = up.aType,
            up.sCon = up.aCon,
            up.sTissueSide = up.sp_charTissueSide,
            up.sTissueSite = up.sp_charTissueSite;</sql>
		<sql>update (
            select specimenReq.PARENT_SPECIMEN_ID as sParentId, aspecimen.PARENT_SPECIMEN_ID as aParentId, 
            specimenReq.INITIAL_QUANTITY as sInitQty, aspecimen.INITIAL_QUANTITY as aInitQty,
            specimenReq.PATHOLOGICAL_STATUS as sPathStatus, aspecimen.PATHOLOGICAL_STATUS as aPathStatus,
            specimenReq.LINEAGE as sLineage, aspecimen.LINEAGE as aLineage,
            specimenReq.SPECIMEN_CLASS as sClass, aspecimen.SPECIMEN_CLASS as aClass,
            specimenReq.SPECIMEN_TYPE as sType, aspecimen.SPECIMEN_TYPE as aType,
            specimenReq.CONCENTRATION as sCon, aspecimen.CONCENTRATION as aCon,
            specimenReq.tissue_side as sTissueSide, sp_char.tissue_side as sp_charTissueSide,
            specimenReq.tissue_site as sTissueSite, sp_char.tissue_site as sp_charTissueSite from 
            catissue_cp_req_specimen specimenReq join catissue_abstract_specimen aspecimen on aspecimen.identifier = specimenReq.identifier
            left join catissue_specimen_char sp_char on sp_char.identifier = aspecimen.SPECIMEN_CHARACTERISTICS_ID
            where specimenReq.identifier is not null
            ) up
            set up.sParentId = up.aParentId,
            up.sInitQty = up.aInitQty,
            up.sPathStatus = up.aPathStatus,
            up.sLineage = up.aLineage,
            up.sClass = up.aClass,
            up.sType = up.aType,
            up.sCon = up.aCon,
            up.sTissueSide = up.sp_charTissueSide,
            up.sTissueSite = up.sp_charTissueSite;</sql>
		<sql>merge into catissue_cp_req_specimen t2
			   using ( select event.EVENT_TIMESTAMP as aTime, 
			event.COMMENTS as aComments,
			collEvent.COLLECTION_PROCEDURE as aProcedure,
			collEvent.CONTAINER as aContainer,
			event.USER_ID as aCollector,
			event.SPECIMEN_ID as specId
			from 
			catissue_specimen_event_param event join catissue_coll_event_param collEvent on collEvent.identifier = event.identifier  ) t1
			      on ( t2.identifier = t1.specId AND  t2.identifier is not null)
			    when matched
			    then update
			     set   t2.COLLECTION_PROCEDURE = t1.aProcedure, 
			            t2.COLLECTION_TIMESTAMP = t1.aTime,
			            t2.COLLECTION_COMMENTS = t1.aComments,
			            t2.COLLECTION_CONTAINER = t1.aContainer,
			            t2.COLLECTOR_ID = t1.aCollector;</sql>
	   <sql>merge into catissue_cp_req_specimen t2
			   using ( select event.EVENT_TIMESTAMP as aTime, 
			event.COMMENTS as aComments,
			recEvent.RECEIVED_QUALITY as aQuality,
			event.USER_ID as aReceiver,
			event.SPECIMEN_ID as specId
			from 
			catissue_specimen_event_param event join catissue_received_event_param recEvent on recEvent.identifier = event.identifier  ) t1
			      on ( t2.identifier = t1.specId AND  t2.identifier is not null)
			    when matched
			    then update
			     set   t2.RECEIVED_QUALITY = t1.aQuality, 
			            t2.RECEIVED_TIMESTAMP = t1.aTime,
			            t2.RECEIVED_COMMENTS = t1.aComments,
			            t2.RECEIVER_ID = t1.aReceiver;</sql>
	   <sql>commit;</sql>
    </changeSet>
    
    <changeSet author="nitesh" id="8" failOnError="false" dbms="mysql">
        <sql>SET FOREIGN_KEY_CHECKS=0;</sql>
    </changeSet>

    <changeSet author="nitesh" id="9" failOnError="false">
	     <addForeignKeyConstraint baseColumnNames="PARENT_SPECIMEN_ID"
	               baseTableName="CATISSUE_CP_REQ_SPECIMEN"
	               constraintName="FK_PARENT_CP_REQ_SPECIMEN"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_CP_REQ_SPECIMEN"/>
         <addForeignKeyConstraint baseColumnNames="COLLECTOR_ID"
                   baseTableName="CATISSUE_CP_REQ_SPECIMEN"
                   constraintName="FK_COLLECTOR_CP_REQ_SPECIMEN"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_USER"/>
         <addForeignKeyConstraint baseColumnNames="RECEIVER_ID"
                   baseTableName="CATISSUE_CP_REQ_SPECIMEN"
                   constraintName="FK_RECEIVER_CP_REQ_SPECIMEN"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_USER"/>
    </changeSet>
    <changeSet author="nitesh" id="10" failOnError="false">
	 <addForeignKeyConstraint baseColumnNames="PARENT_SPECIMEN_ID"
	               baseTableName="CATISSUE_SPECIMEN"
	               constraintName="FK_PARENT_SPECIMEN"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="11" failOnError="false">
         <createIndex 
	            indexName="idx_specimen_class"
	            tableName="CATISSUE_SPECIMEN"
	            unique="false">
	        <column name="SPECIMEN_CLASS" type="varchar(50)"/>
	    </createIndex>
	 </changeSet>
    <changeSet author="nitesh" id="12" failOnError="false">
	    <createIndex 
                indexName="idx_specimen_type"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="SPECIMEN_TYPE" type="varchar(50)"/>
        </createIndex>
      </changeSet>
    <changeSet author="nitesh" id="13" failOnError="false">
        <createIndex 
                indexName="idx_pathology_stat"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="PATHOLOGICAL_STATUS" type="varchar(50)"/>
        </createIndex>
     </changeSet>
    <changeSet author="nitesh" id="14" failOnError="false">
        <createIndex 
                indexName="idx_init_quantity"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="INITIAL_QUANTITY" type="varchar(50)"/>
        </createIndex>
      </changeSet>
    <changeSet author="nitesh" id="15" failOnError="false">
        <createIndex 
                indexName="idx_specimen_lineage"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="LINEAGE" type="varchar(50)"/>
        </createIndex>
	</changeSet>
	
	<changeSet author="nitesh" id="16" failOnError="false">
        <createIndex 
                indexName="idx_specimen_req_class"
                tableName="CATISSUE_CP_REQ_SPECIMEN"
                unique="false">
            <column name="SPECIMEN_CLASS" type="varchar(50)"/>
        </createIndex>
     </changeSet>
    <changeSet author="nitesh" id="17" failOnError="false">
        <createIndex 
                indexName="idx_specimen_req_type"
                tableName="CATISSUE_CP_REQ_SPECIMEN"
                unique="false">
            <column name="SPECIMEN_TYPE" type="varchar(50)"/>
        </createIndex>
     </changeSet>
    <changeSet author="nitesh" id="18" failOnError="false">
        <createIndex 
                indexName="idx_spec_req_pathology_stat"
                tableName="CATISSUE_CP_REQ_SPECIMEN"
                unique="false">
            <column name="PATHOLOGICAL_STATUS" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    <changeSet author="nitesh" id="19" failOnError="false" dbms="mysql">
        <sql>SET FOREIGN_KEY_CHECKS=1;</sql>
    </changeSet>

    <changeSet id="20" author="nitesh" runOnChange="false">
	<preConditions  onFail="MARK_RAN">
	    <not>
		<columnExists tableName="CATISSUE_COLL_EVENT_PARAM" columnName="EVENT_TIMESTAMP"  />
	    </not>			
	</preConditions>

        <addColumn tableName="CATISSUE_COLL_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLL_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLL_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLL_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_FIXED_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FIXED_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FIXED_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FIXED_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_FROZEN_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FROZEN_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FROZEN_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FROZEN_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
         <addColumn tableName="CATISSUE_IN_OUT_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_IN_OUT_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_IN_OUT_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_IN_OUT_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_PROCEDURE_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_PROCEDURE_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_PROCEDURE_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_PROCEDURE_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
         <addColumn tableName="CATISSUE_SPUN_EVENT_PARAMETERS">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPUN_EVENT_PARAMETERS">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPUN_EVENT_PARAMETERS">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPUN_EVENT_PARAMETERS">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
         <addColumn tableName="CATISSUE_TRANSFER_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_TRANSFER_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_TRANSFER_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_TRANSFER_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_RECEIVED_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_RECEIVED_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_RECEIVED_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_RECEIVED_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_EMBEDDED_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_EMBEDDED_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_EMBEDDED_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_EMBEDDED_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_THAW_EVENT_PARAMETERS">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_THAW_EVENT_PARAMETERS">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_THAW_EVENT_PARAMETERS">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_THAW_EVENT_PARAMETERS">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_CELL_SPE_REVIEW_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CELL_SPE_REVIEW_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CELL_SPE_REVIEW_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_CELL_SPE_REVIEW_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_TIS_SPE_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_TIS_SPE_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_TIS_SPE_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_TIS_SPE_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_FLUID_SPE_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FLUID_SPE_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FLUID_SPE_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_FLUID_SPE_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_MOL_SPE_REVIEW_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_MOL_SPE_REVIEW_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_MOL_SPE_REVIEW_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_MOL_SPE_REVIEW_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
        
        <addColumn tableName="CATISSUE_DISPOSAL_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISPOSAL_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISPOSAL_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISPOSAL_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
    </changeSet>

    <changeSet id="20.1" author="nitesh" runOnChange="false">
		<preConditions  onFail="MARK_RAN">
			<and>
				<tableExists  tableName="CATISSUE_DISTRI_EVENT_PARAM" />
				<not>
					<columnExists tableName="CATISSUE_DISTRI_EVENT_PARAM" columnName="EVENT_TIMESTAMP"/>
				</not>
			</and>
		</preConditions>
        
        <addColumn tableName="CATISSUE_DISTRI_EVENT_PARAM">
            <column name="EVENT_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRI_EVENT_PARAM">
            <column name="SPECIMEN_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRI_EVENT_PARAM">
            <column name="USER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRI_EVENT_PARAM">
            <column name="COMMENTS" type="${text.type}(500)" />
        </addColumn>
    </changeSet>
    
    <!-- <changeSet id="21" author="nitesh">
        <createTable tableName="CATISSUE_SPEC_EVENT_MAPPING">
	        <column name="IDENTIFIER" type="${int.type}"/>
	        <column name="EVENT_TYPE" type="${text.type}(50)"/>
	        <column name="SPECIMEN_ID" type="${int.type}"/>
        </createTable>
        <addPrimaryKey columnNames="IDENTIFIER"
            constraintName="PK_CATISSUE_SPEC_EVENT_MAPPING"
            tableName="CATISSUE_SPEC_EVENT_MAPPING"
            />
    </changeSet>
    
    <changeSet id="adding autoIncrement for CATISSUE_SPEC_EVENT_MAPPING" author="nitesh" dbms="mysql">
        <addAutoIncrement columnDataType="${int.type}"
            columnName="IDENTIFIER"
            tableName="CATISSUE_SPEC_EVENT_MAPPING"/>
    </changeSet>-->  

    <changeSet id="22" author="nitesh" dbms="mysql">
        <sql>DROP PROCEDURE IF EXISTS  migrate_events_data;</sql>
       <sql splitStatements="false">
       CREATE PROCEDURE migrate_events_data(eventTabName varchar(50))
        BEGIN
            SET @sql=CONCAT("update ", eventTabName ," collEvent join catissue_specimen_event_param event
				on event.identifier = collEvent.identifier
				set collEvent.EVENT_TIMESTAMP = event.EVENT_TIMESTAMP,
				collEvent.SPECIMEN_ID = event.SPECIMEN_ID,
				collEvent.USER_ID = event.USER_ID,
				collEvent.COMMENTS = event.COMMENTS where collEvent.identifier is not null");
    
            PREPARE s1 FROM @sql;
            EXECUTE s1;
            DEALLOCATE PREPARE s1;
        END
    </sql>
    </changeSet>
    <changeSet id="23" author="nitesh" dbms="oracle">
       <sql splitStatements="false" endDelimiter="$">
       create or replace
		PROCEDURE migrate_events_data (eventTabName varchar2) AS
		updateQuery varchar2(1000);
		BEGIN
		updateQuery := 'update ( select collEvent.EVENT_TIMESTAMP as cTime, event.EVENT_TIMESTAMP as etime,
		collEvent.SPECIMEN_ID as cSpecId, event.SPECIMEN_ID as eSpecId,
		collEvent.USER_ID as cUserId, event.USER_ID as eUserId,
		collEvent.COMMENTS as cComments, event.COMMENTS as eComments
		from '|| eventTabName ||' collEvent join catissue_specimen_event_param event
		on collEvent.identifier = event.identifier
		)up
		set up.cTime = up.etime,up.cSpecId = up.eSpecId,up.cUserId = up.eUserId,up.cComments = up.eComments';
		EXECUTE IMMEDIATE updateQuery;
		END migrate_events_data;
    </sql>
    </changeSet>
    <changeSet id="24" author="nitesh">
    <sql>call migrate_events_data('CATISSUE_FIXED_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_FROZEN_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_IN_OUT_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_PROCEDURE_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_SPUN_EVENT_PARAMETERS');</sql>
    <sql>call migrate_events_data('CATISSUE_TRANSFER_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_COLL_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_RECEIVED_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_EMBEDDED_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_THAW_EVENT_PARAMETERS');</sql>
    <sql>call migrate_events_data('CATISSUE_CELL_SPE_REVIEW_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_TIS_SPE_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_FLUID_SPE_EVENT_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_MOL_SPE_REVIEW_PARAM');</sql>
    <sql>call migrate_events_data('CATISSUE_DISPOSAL_EVENT_PARAM');</sql>
    <!--sql>call migrate_events_data('CATISSUE_DISTRI_EVENT_PARAM');</sql-->
    <sql>commit;</sql>
    </changeSet>
    
   <!--  <changeSet id="25" author="nitesh">
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'FIXED', event.identifier, event.specimen_id from CATISSUE_FIXED_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'FROZEN', event.identifier, event.specimen_id from CATISSUE_FROZEN_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'CHECKIN CHECKOUT', event.identifier, event.specimen_id from CATISSUE_IN_OUT_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'PROCEDURE', event.identifier, event.specimen_id from CATISSUE_PROCEDURE_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'SPUN', event.identifier, event.specimen_id from CATISSUE_SPUN_EVENT_PARAMETERS event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'TRANSFER', event.identifier, event.specimen_id from CATISSUE_TRANSFER_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'COLLECTION', event.identifier, event.specimen_id from CATISSUE_COLL_EVENT_PARAM event join 
            catissue_specimen spec on event.specimen_id = spec.identifier</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID)
            select 'RECEIVED', event.identifier, event.specimen_id from CATISSUE_RECEIVED_EVENT_PARAM event join 
            catissue_specimen spec on event.specimen_id = spec.identifier</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'EMBEDDED', event.identifier, event.specimen_id from CATISSUE_EMBEDDED_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'THAW', event.identifier, event.specimen_id from CATISSUE_THAW_EVENT_PARAMETERS event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'CELL SPECIMEN REVIEW', event.identifier, event.specimen_id from CATISSUE_CELL_SPE_REVIEW_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'TISSUE SPECIMEN REVIEW', event.identifier, event.specimen_id from CATISSUE_TIS_SPE_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'FLUID SPECIMEN REVIEW', event.identifier, event.specimen_id from CATISSUE_FLUID_SPE_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'MOLECULAR SPECIMEN REVIEW', event.identifier, event.specimen_id from CATISSUE_MOL_SPE_REVIEW_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'DISPOSAL', event.identifier, event.specimen_id from CATISSUE_DISPOSAL_EVENT_PARAM event</sql>
        <sql>insert into catissue_spec_event_mapping(EVENT_TYPE,IDENTIFIER,SPECIMEN_ID) 
            select 'DISTRIBUTION', event.identifier, event.specimen_id from CATISSUE_DISTRI_EVENT_PARAM event</sql>
    </changeSet>-->
    <changeSet id="creating procedure for duplicate specimen event deletion" author="nitesh" dbms="oracle">
        <sql splitStatements="false" endDelimiter="$">
            CREATE OR REPLACE
            PROCEDURE DEL_DUP_SPE_COLL_EVENTS 
            IS
               cnt number;
               scgId number;
               cnumber number;
               eventId number;
            BEGIN   
            for d in (select cnt, scgId from (select count(*) as cnt, event.specimen_id as scgId 
                from catissue_specimen t2 join catissue_specimen_event_param event on 
                event.specimen_id = t2.identifier
                inner join catissue_coll_event_param collEvent on collEvent.identifier = event.identifier 
                group by event.specimen_id) t1 where t1.cnt > 1)
               loop
               cnt:=d.cnt;
                for e in (select identifier from catissue_coll_event_param where specimen_id = d.scgId)
                loop
                        
                    if(cnt != 1) then
                            
                        delete from catissue_coll_event_param where identifier = e.identifier;
                        delete from catissue_specimen_event_param where identifier = e.identifier;
                    end if;
                            cnt:=cnt-1;
                end loop;
                end loop;
            commit;   
            END DEL_DUP_SPE_COLL_EVENTS;
    </sql>
    <sql splitStatements="false" endDelimiter="$">
            CREATE OR REPLACE
            PROCEDURE DEL_DUP_SPE_REC_EVENTS 
            IS
               cnt number;
               scgId number;
               cnumber number;
               eventId number;
            BEGIN   
            for d in (select cnt, scgId from (select count(*) as cnt, event.specimen_id as scgId 
                from catissue_specimen t2 join catissue_specimen_event_param event on 
                event.specimen_id = t2.identifier
                inner join catissue_received_event_param collEvent on collEvent.identifier = event.identifier 
                group by event.specimen_id) t1 where t1.cnt > 1)
               loop
               cnt:=d.cnt;
                for e in (select identifier from catissue_received_event_param where specimen_id = d.scgId)
                loop
                        
                    if(cnt != 1) then
                            
                        delete from catissue_received_event_param where identifier = e.identifier;
                        delete from catissue_specimen_event_param where identifier = e.identifier;
                    end if;
                            cnt:=cnt-1;
                end loop;
                end loop;
            commit;   
            END DEL_DUP_SPE_REC_EVENTS;
    </sql>
    <sql>call DEL_DUP_SPE_COLL_EVENTS();</sql>
    <sql>call DEL_DUP_SPE_REC_EVENTS();</sql>
    <sql>commit;</sql>
    </changeSet>
    <changeSet id="26" author="nitesh">
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="COLLECTOR_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="COLLECTION_CONTAINER" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="COLLECTION_PROCEDURE" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="COLLECTION_COMMENTS" type="${text.type}(500)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="COLLECTION_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="RECEIVER_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="RECEIVED_COMMENTS" type="${text.type}(500)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="RECEIVED_TIMESTAMP" type="${datetime.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="RECEIVED_QUALITY" type="${text.type}(50)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="27" author="nitesh" dbms="mysql">
        <sql>update catissue_specimen_coll_group scg join catissue_specimen_event_param event on 
            event.specimen_coll_grp_id = scg.identifier join catissue_coll_event_param collEvent on 
            collEvent.identifier = event.identifier 
            set 
            scg.COLLECTION_TIMESTAMP = event.EVENT_TIMESTAMP,
            scg.COLLECTION_COMMENTS = event.COMMENTS,
            scg.COLLECTION_PROCEDURE = collEvent.COLLECTION_PROCEDURE,
            scg.COLLECTION_CONTAINER = collEvent.CONTAINER,
            scg.COLLECTOR_ID = event.USER_ID 
            where scg.identifier is not null</sql>
        <sql>update catissue_specimen_coll_group scg join catissue_specimen_event_param event on 
            event.specimen_coll_grp_id = scg.identifier join catissue_received_event_param recEvent on
            recEvent.identifier = event.identifier
            set 
            scg.RECEIVED_QUALITY = recEvent.RECEIVED_QUALITY,
            scg.RECEIVED_TIMESTAMP = event.EVENT_TIMESTAMP,
            scg.RECEIVED_COMMENTS = event.COMMENTS,
            scg.RECEIVER_ID =  event.USER_ID where scg.identifier is not null</sql>
        <sql>commit;</sql>
    </changeSet>
    <changeSet id="creating procedure for duplicate SCG event deletion" author="nitesh" dbms="oracle">
        <sql splitStatements="false" endDelimiter="$">
            create or replace
            PROCEDURE DEL_DUP_SCG_COLL_EVENTS 
            IS
               cnt number;
               scgId number;
               cnumber number;
               eventId number;
            BEGIN   
            for d in (select cnt, scgId from (select count(*) as cnt, event.specimen_coll_grp_id as scgId 
                from catissue_specimen_coll_group t2 join catissue_specimen_event_param event on 
                event.specimen_coll_grp_id = t2.identifier
                inner join catissue_coll_event_param collEvent on collEvent.identifier = event.identifier 
                group by event.specimen_coll_grp_id) t1 where t1.cnt > 1)
               loop
               cnt:=d.cnt;
                for e in (select ep.identifier as id from catissue_specimen_event_param ep join 
                            catissue_coll_event_param cep on ep.identifier = cep.identifier where ep.specimen_coll_grp_id = d.scgId)
                loop
                    if(cnt != 1) then
                        delete from catissue_coll_event_param where identifier = e.id;
                        delete from catissue_specimen_event_param where identifier = e.id;
                    end if;
                    cnt:=cnt-1;
                end loop;
                end loop;
            commit;   
            END DEL_DUP_SCG_COLL_EVENTS;
    </sql>
    <sql splitStatements="false" endDelimiter="$">
            create or replace
PROCEDURE DEL_DUP_SCG_REC_EVENTS 
            IS
               cnt number;
               scgId number;
               cnumber number;
               eventId number;
            BEGIN   
            for d in (select cnt, scgId from (select count(*) as cnt, event.specimen_coll_grp_id as scgId 
                from catissue_specimen_coll_group t2 join catissue_specimen_event_param event on 
                event.specimen_coll_grp_id = t2.identifier
                inner join catissue_received_event_param collEvent on collEvent.identifier = event.identifier 
                group by event.specimen_coll_grp_id) t1 where t1.cnt > 1)
               loop
               cnt:=d.cnt;
                for e in (select ep.identifier as id from catissue_specimen_event_param ep join 
                            catissue_received_event_param cep on ep.identifier = cep.identifier where ep.specimen_coll_grp_id = d.scgId)
                loop
                    if(cnt != 1) then
                        delete from catissue_received_event_param where identifier = e.id;
                        delete from catissue_specimen_event_param where identifier = e.id;
                    end if;
                    cnt:=cnt-1;
                end loop;
                end loop;
            commit;   
            END DEL_DUP_SCG_REC_EVENTS;
    </sql>
    <sql>call DEL_DUP_SCG_COLL_EVENTS();</sql>
    <sql>call DEL_DUP_SCG_REC_EVENTS();</sql>
    <sql>commit;</sql>
    </changeSet>
    
    <changeSet id="28" author="nitesh" dbms="oracle">
    
        <sql>merge into catissue_specimen_coll_group t2
               using ( select event.EVENT_TIMESTAMP as aTime, 
            event.COMMENTS as aComments,
            collEvent.COLLECTION_PROCEDURE as aProcedure,
            collEvent.CONTAINER as aContainer,
            event.USER_ID as aCollector,
            event.specimen_coll_grp_id as specId
            from 
            catissue_specimen_event_param event join catissue_coll_event_param collEvent on collEvent.identifier = event.identifier  ) t1
                  on ( t2.identifier = t1.specId AND  t2.identifier is not null)
                when matched
                then update
                 set   t2.COLLECTION_PROCEDURE = t1.aProcedure, 
                        t2.COLLECTION_TIMESTAMP = t1.aTime,
                        t2.COLLECTION_COMMENTS = t1.aComments,
                        t2.COLLECTION_CONTAINER = t1.aContainer,
                        t2.COLLECTOR_ID = t1.aCollector;</sql>
       <sql>merge into catissue_specimen_coll_group t2
               using ( select event.EVENT_TIMESTAMP as aTime, 
            event.COMMENTS as aComments,
            recEvent.RECEIVED_QUALITY as aQuality,
            event.USER_ID as aReceiver,
            event.specimen_coll_grp_id as specId
            from 
            catissue_specimen_event_param event join catissue_received_event_param recEvent on recEvent.identifier = event.identifier  ) t1
                  on ( t2.identifier = t1.specId AND  t2.identifier is not null)
                when matched
                then update
                 set   t2.RECEIVED_QUALITY = t1.aQuality, 
                        t2.RECEIVED_TIMESTAMP = t1.aTime,
                        t2.RECEIVED_COMMENTS = t1.aComments,
                        t2.RECEIVER_ID = t1.aReceiver;</sql>
       <sql>commit;</sql>
    </changeSet>
    
    <changeSet id="29" author="nitesh" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_RECEIVED_EVENT_PARAM" constraintName="FKA7139D06BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_COLL_EVENT_PARAM" constraintName="FKF9888F91BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_FLUID_SPE_EVENT_PARAM" constraintName="FK70565D20BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_SPUN_EVENT_PARAMETERS" constraintName="FK312D77BCBC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_PROCEDURE_EVENT_PARAM" constraintName="FKEC6B4260BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_FIXED_EVENT_PARAM" constraintName="FKE0F1781BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_THAW_EVENT_PARAMETERS" constraintName="FKD8890A48BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_FROZEN_EVENT_PARAM" constraintName="FK52627245BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_TIS_SPE_EVENT_PARAM" constraintName="FKBB9648F4BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_TRANSFER_EVENT_PARAM" constraintName="FK71F9AC10BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_MOL_SPE_REVIEW_PARAM" constraintName="FK5280ECEBC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_EMBEDDED_EVENT_PARAM" constraintName="FKD356182FBC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_IN_OUT_EVENT_PARAM" constraintName="FK4F0FAEB9BC7298A9"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_DISPOSAL_EVENT_PARAM" constraintName="FK1BC818D6BC7298A9"/>
    </changeSet>
    
    <changeSet id="30" author="nitesh" runOnChange="true">
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="CLINICAL_DIAGNOSIS" type="${text.type}(150)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="CLINICAL_STATUS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="ACTIVITY_STATUS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
            <column name="SITE_ID" type="${int.type}" />
        </addColumn>
    </changeSet>
    
    <changeSet id="31" author="nitesh" runOnChange="true">
        <addColumn tableName="CATISSUE_COLL_PROT_EVENT">
            <column name="CLINICAL_DIAGNOSIS" type="${text.type}(150)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLL_PROT_EVENT">
            <column name="ACTIVITY_STATUS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLL_PROT_EVENT">
            <column name="SITE_ID" type="${int.type}" />
        </addColumn>
    </changeSet>
    
    <changeSet id="32" author="nitesh" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_COLL_PROT_EVENT" constraintName="FK_PARENT_COLL_PROT_EVENT"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_SPECIMEN_COLL_GROUP" constraintName="FK_PARENT_SPEC_COLL_GROUP"/>
    </changeSet>

    <changeSet id="33" author="nitesh" dbms="mysql">
        <sql>update catissue_specimen_coll_group scg join catissue_abs_speci_coll_group ascg on 
            ascg.identifier = scg.identifier 
            set 
            scg.CLINICAL_DIAGNOSIS = ascg.CLINICAL_DIAGNOSIS,
            scg.CLINICAL_STATUS = ascg.CLINICAL_STATUS,
            scg.ACTIVITY_STATUS = ascg.ACTIVITY_STATUS,
            scg.SITE_ID =  ascg.SITE_ID where scg.identifier is not null</sql>
        <sql>update catissue_coll_prot_event cpe join catissue_abs_speci_coll_group ascg on 
            ascg.identifier = cpe.identifier 
            set 
            cpe.CLINICAL_DIAGNOSIS = ascg.CLINICAL_DIAGNOSIS,
            cpe.CLINICAL_STATUS = ascg.CLINICAL_STATUS,
            cpe.ACTIVITY_STATUS = ascg.ACTIVITY_STATUS,
            cpe.SITE_ID =  ascg.SITE_ID where cpe.identifier is not null</sql>
    </changeSet>
    
    <changeSet id="34" author="nitesh" dbms="oracle">
        <sql>update (
            select scg.CLINICAL_DIAGNOSIS as sClinDiagnosis, ascg.CLINICAL_DIAGNOSIS as aClinDiagnosis, 
            scg.CLINICAL_STATUS as sClinStatus, ascg.CLINICAL_STATUS as aClinStatus,
            scg.ACTIVITY_STATUS as sActStatus, ascg.ACTIVITY_STATUS as aActStatus,
            scg.SITE_ID as sSiteId, ascg.SITE_ID as aSiteId
            from 
            catissue_specimen_coll_group scg join catissue_abs_speci_coll_group ascg on 
            ascg.identifier = scg.identifier 
            where scg.identifier is not null
            ) up
            set up.sClinStatus = up.aClinStatus,
            up.sClinDiagnosis = up.aClinDiagnosis,
            up.sActStatus = up.aActStatus,
            up.sSiteId = up.aSiteId;</sql>
        <sql>update (
            select cpe.CLINICAL_DIAGNOSIS as sClinDiagnosis, ascg.CLINICAL_DIAGNOSIS as aClinDiagnosis, 
            cpe.CLINICAL_STATUS as sClinStatus, ascg.CLINICAL_STATUS as aClinStatus,
            cpe.ACTIVITY_STATUS as sActStatus, ascg.ACTIVITY_STATUS as aActStatus,
            cpe.SITE_ID as sSiteId, ascg.SITE_ID as aSiteId
            from 
            catissue_coll_prot_event cpe join catissue_abs_speci_coll_group ascg on 
            ascg.identifier = cpe.identifier 
            where cpe.identifier is not null
            ) up
            set up.sClinStatus = up.aClinStatus,
            up.sClinDiagnosis = up.aClinDiagnosis,
            up.sActStatus = up.aActStatus,
            up.sSiteId = up.aSiteId;</sql>
      </changeSet>    
      
      <changeSet id="35" author="nitesh" dbms="oracle">
        <sql endDelimiter="/">BEGIN
			DECLARE
			reqId NUMBER;
			cpeId NUMBER;
			dpId NUMBER;
			  BEGIN
			  SELECT NVL(MAX(IDENTIFIER),0)+1
			  INTO reqId
			  FROM CATISSUE_CP_REQ_SPECIMEN;
			  
			  SELECT NVL(MAX(IDENTIFIER),0)+1
			  INTO cpeId
			  FROM CATISSUE_COLL_PROT_EVENT;
			  
			  SELECT NVL(MAX(IDENTIFIER),0)+1
              INTO dpId
              FROM CATISSUE_DISTRIBUTION_PROTOCOL;
              
			  execute immediate('CREATE SEQUENCE CATISSUE_REQ_SPECIMEN_SEQ MINVALUE 0 START WITH '||reqId||' INCREMENT BY 1 NOCACHE');
			  execute immediate('CREATE SEQUENCE CATISSUE_COLL_PROT_EV_SEQ MINVALUE 0 START WITH '||cpeId||' INCREMENT BY 1 NOCACHE');
			  execute immediate('CREATE SEQUENCE CATISSUE_DISTRI_PROT_SEQ MINVALUE 0 START WITH '||dpId||' INCREMENT BY 1 NOCACHE');
			  END;
			END;
			/
        </sql>
      </changeSet>
      
    <changeSet author="nitesh" id="disable foreign key check" failOnError="false" dbms="mysql">
        <sql>SET FOREIGN_KEY_CHECKS=0;</sql>
    </changeSet>
    
    <!-- <changeSet author="nitesh" id="36" failOnError="false">
        
     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
               baseTableName="CATISSUE_SPEC_EVENT_MAPPING"
               constraintName="FK_SPECIMEN_EVENT_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet> -->

    <changeSet author="nitesh" id="enable foreign key check" failOnError="false" dbms="mysql">
        <sql>SET FOREIGN_KEY_CHECKS=0;</sql>
    </changeSet>
     
    <changeSet author="nitesh" id="37" failOnError="false">
	     <addForeignKeyConstraint baseColumnNames="COLLECTOR_ID"
	               baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
	               constraintName="FK_USER_EVENT_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="RECEIVER_ID"
	               baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
	               constraintName="FK_RECEIVER_ID_SCG"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SITE_ID"
	               baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
	               constraintName="FK_SITE_ID_SCG"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SITE"/>
    </changeSet>
    
    <changeSet author="nitesh" id="38" failOnError="false">
	     <addForeignKeyConstraint baseColumnNames="SITE_ID"
	               baseTableName="CATISSUE_COLL_PROT_EVENT"
	               constraintName="FK_SITE_ID_CPE"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SITE"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_COLL_EVENT_PARAM" failOnError="false">
	     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_COLL_EVENT_PARAM"
	               constraintName="FK_COLL_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_COLL_EVENT_PARAM"
	               constraintName="FK_USER_COLL_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_COLL_EVENT_PARAM"
	               constraintName="FK_SPEC_COLL_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_FIXED_EVENT_PARAM" failOnError="false">
	     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_FIXED_EVENT_PARAM"
	               constraintName="FK_FIXED_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_FIXED_EVENT_PARAM"
	               constraintName="FK_USER_FIXED_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_FIXED_EVENT_PARAM"
	               constraintName="FK_SPEC_FIXED_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_FROZEN_EVENT_PARAM" failOnError="false">
	    <!--  <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_FROZEN_EVENT_PARAM"
	               constraintName="FK_FROZEN_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_FROZEN_EVENT_PARAM"
	               constraintName="FK_USER_FROZEN_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	    <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_FROZEN_EVENT_PARAM"
	               constraintName="FK_SPEC_FROZEN_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_IN_OUT_EVENT_PARAM" failOnError="false">
	    <!--  <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_IN_OUT_EVENT_PARAM"
	               constraintName="FK_INOUT_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_IN_OUT_EVENT_PARAM"
	               constraintName="FK_USER_INOUT_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_IN_OUT_EVENT_PARAM"
	               constraintName="FK_SPEC_IN_OUT_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_PROCEDURE_EVENT_PARAM" failOnError="false">
	     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_PROCEDURE_EVENT_PARAM"
	               constraintName="FK_PROC_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_PROCEDURE_EVENT_PARAM"
	               constraintName="FK_USER_PROC_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_PROCEDURE_EVENT_PARAM"
	               constraintName="FK_SPEC_PROCEDURE_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_SPUN_EVENT_PARAMETERS" failOnError="false">
	    <!--  <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_SPUN_EVENT_PARAMETERS"
	               constraintName="FK_SPUN_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_SPUN_EVENT_PARAMETERS"
	               constraintName="FK_USER_SPUN_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_SPUN_EVENT_PARAMETERS"
	               constraintName="FK_SPEC_SPUN_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_TRANSFER_EVENT_PARAM" failOnError="false">
	   <!--   <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_TRANSFER_EVENT_PARAM"
	               constraintName="FK_TRNSFR_EV_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_TRANSFER_EVENT_PARAM"
	               constraintName="FK_USER_TRANSFER_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_TRANSFER_EVENT_PARAM"
	               constraintName="FK_SPEC_TRANSFER_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_RECEIVED_EVENT_PARAM" failOnError="false">
	    <!--  <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
	               baseTableName="CATISSUE_RECEIVED_EVENT_PARAM"
	               constraintName="FK_REC_EVENT_TO_EV_MAPPING"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/>--> 
	     <addForeignKeyConstraint baseColumnNames="USER_ID"
	               baseTableName="CATISSUE_RECEIVED_EVENT_PARAM"
	               constraintName="FK_USER_REC_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_USER"/>
	     <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_RECEIVED_EVENT_PARAM"
	               constraintName="FK_SPEC_REC_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_EMBEDDED_EVENT_PARAM" failOnError="false">
     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_EMBEDDED_EVENT_PARAM"
               constraintName="FK_EMB_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
        <addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_EMBEDDED_EVENT_PARAM"
               constraintName="FK_USER_EMB_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_EMBEDDED_EVENT_PARAM"
	               constraintName="FK_SPEC_EMBEDDED_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_THAW_EVENT_PARAMETERS" failOnError="false">
     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_THAW_EVENT_PARAMETERS"
               constraintName="FK_THAW_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
        <addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_THAW_EVENT_PARAMETERS"
               constraintName="FK_USER_THAW_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_THAW_EVENT_PARAMETERS"
	               constraintName="FK_SPEC_THAW_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_CELL_SPE_REVIEW_PARAM" failOnError="false">
     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_CELL_SPE_REVIEW_PARAM"
               constraintName="FK_CELL_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
     	<dropForeignKeyConstraint baseTableName="CATISSUE_CELL_SPE_REVIEW_PARAM" constraintName="FK52F40EDEBC7298A9"/>
     	<addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_CELL_SPE_REVIEW_PARAM"
               constraintName="FK_USER_CELL_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_CELL_SPE_REVIEW_PARAM"
	               constraintName="FK_SPEC_CELL_REV_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/> 
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_TIS_SPE_EVENT_PARAM" failOnError="false">
     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_TIS_SPE_EVENT_PARAM"
               constraintName="FK_TISSUE_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
     	<addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_TIS_SPE_EVENT_PARAM"
               constraintName="FK_USER_TISSUE_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_TIS_SPE_EVENT_PARAM"
	               constraintName="FK_SPEC_TISSUE_REV_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_FLUID_SPE_EVENT_PARAM" failOnError="false">
     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_FLUID_SPE_EVENT_PARAM"
               constraintName="FK_FLUID_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
        <addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_FLUID_SPE_EVENT_PARAM"
               constraintName="FK_USER_FLUID_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_FLUID_SPE_EVENT_PARAM"
	               constraintName="FK_SPEC_FLUID_REV_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_MOL_SPE_REVIEW_PARAM" failOnError="false">
     <!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_MOL_SPE_REVIEW_PARAM"
               constraintName="FK_MOL_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
         <addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_MOL_SPE_REVIEW_PARAM"
               constraintName="FK_USER_MOL_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
         <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_MOL_SPE_REVIEW_PARAM"
	               constraintName="FK_SPEC_MOL_REV_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_DISPOSAL_EVENT_PARAM" failOnError="false">
    <!--  <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_DISPOSAL_EVENT_PARAM"
               constraintName="FK_DISP_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
        <addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_DISPOSAL_EVENT_PARAM"
               constraintName="FK_USER_DISP_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
	               baseTableName="CATISSUE_DISPOSAL_EVENT_PARAM"
	               constraintName="FK_SPEC_DISPOSAL_EVENT"
	               referencedColumnNames="IDENTIFIER"
	               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>
    
    <changeSet author="nitesh" id="adding FK for CATISSUE_DISTRI_EVENT_PARAM" failOnError="false">
		<preConditions  onFail="MARK_RAN">
		       <tableExists  tableName="CATISSUE_DISTRI_EVENT_PARAM" />
		</preConditions>
     	<!-- <addForeignKeyConstraint baseColumnNames="IDENTIFIER"
               baseTableName="CATISSUE_DISTRI_EVENT_PARAM"
               constraintName="FK_DISTRI_EVENT_TO_EV_MAPPING"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPEC_EVENT_MAPPING"/> -->
        <addForeignKeyConstraint baseColumnNames="USER_ID"
               baseTableName="CATISSUE_DISTRI_EVENT_PARAM"
               constraintName="FK_USER_DISTRI_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_USER"/>
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
               baseTableName="CATISSUE_DISTRI_EVENT_PARAM"
               constraintName="FK_SPEC_DISTRI_EVENT"
               referencedColumnNames="IDENTIFIER"
               referencedTableName="CATISSUE_SPECIMEN"/>
    </changeSet>

    <changeSet author="vpawar" id="adding new form context table" failOnError="true">
      <createTable tableName="CATISSUE_FORM_CONTEXT">
        <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
          <constraints primaryKey="true" nullable="false"/>
        </column>

        <column name="CONTAINER_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>

        <column name="ENTITY_TYPE" type="${text.type}(32)">
          <constraints nullable="false"/>
        </column>

        <column name="CP_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>
 
        <column name="SORT_ORDER" type="${smallint.type}"/>
        <column name="IS_MULTIRECORD" type="${boolean.type}" defaultValue="0"/>
      </createTable>
    </changeSet>

    <changeSet author="vpawar" id="adding FK on form context to containers table" failOnError="true">
      <preConditions onFail="MARK_RAN">
	<tableExists tableName="DYEXTN_CONTAINERS" />
      </preConditions>
      <addForeignKeyConstraint 
	constraintName="FK_FC_CNTR_ID_DC_IDENTIFIER"
	baseTableName="CATISSUE_FORM_CONTEXT"
	baseColumnNames="CONTAINER_ID"
	referencedTableName="DYEXTN_CONTAINERS"
	referencedColumnNames="IDENTIFIER"/>
    </changeSet>

     <!-- changeSet author="vpawar" id="adding FK on form context to collection protocol table" failOnError="true">
      <addForeignKeyConstraint 
        constraintName="FK_FC_CP_ID_SP_IDENTIFIER"
        baseTableName="CATISSUE_FORM_CONTEXT"
        baseColumnNames="CP_ID"
        referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
        referencedColumnNames="IDENTIFIER"/>
    </changeSet --> 

     <changeSet author="vpawar" id="adding new form record entries table" failOnError="true">
      <createTable tableName="CATISSUE_FORM_RECORD_ENTRY">
        <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
          <constraints primaryKey="true" nullable="false"/>
        </column>

        <column name="FORM_CTXT_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>

        <column name="OBJECT_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>

        <column name="RECORD_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>

        <column name="UPDATED_BY" type="${int.type}">
          <constraints nullable="false"/>
        </column>

        <column name="UPDATE_TIME" type="${timestamp.type}">
          <constraints nullable="false"/>
        </column>
        
         <column name="ACTIVITY_STATUS" type="${text.type}(16)">
          <constraints nullable="false"/>
        </column>
      </createTable>
    </changeSet>

    <changeSet author="vpawar" id="adding FK on record entries to form context table" failOnError="true">
      <addForeignKeyConstraint 
        constraintName="FK_RE_CTXT_ID_FC_IDENTIFIER"
        baseTableName="CATISSUE_FORM_RECORD_ENTRY"
        baseColumnNames="FORM_CTXT_ID"
        referencedTableName="CATISSUE_FORM_CONTEXT"
        referencedColumnNames="IDENTIFIER"/>
    </changeSet>

    <changeSet author="vpawar" id="adding FK on record entries to users table" failOnError="true">
      <addForeignKeyConstraint 
        constraintName="FK_RE_UPDATED_BY_USERS_ID"
        baseTableName="CATISSUE_FORM_RECORD_ENTRY"
        baseColumnNames="UPDATED_BY"
        referencedTableName="CATISSUE_USER"
        referencedColumnNames="IDENTIFIER"/>
    </changeSet> 
    
    <changeSet id="adding columns for distribution protocol" author="nitesh">
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="PRINCIPAL_INVESTIGATOR_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="TITLE" type="${text.type}(512)" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="SHORT_TITLE" type="${text.type}(512)" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="IRB_IDENTIFIER" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="START_DATE" type="${date.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="END_DATE" type="${date.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="ENROLLMENT" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="DESCRIPTION_URL" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
            <column name="ACTIVITY_STATUS" type="${text.type}(50)" />
        </addColumn>
    </changeSet>
    <changeSet id="updating constraints for distribution protocol" author="nitesh" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_DISTRIBUTION_PROTOCOL" constraintName="FKC8999977BC7298A9"/>
    </changeSet>
    <changeSet id="add unique constraint" author="nitesh" dbms="mysql">
     <sql>ALTER TABLE catissue_distribution_protocol ADD CONSTRAINT idx_ditri_title UNIQUE (TITLE(255))</sql>
     </changeSet>
     <changeSet id="add unique constraint" author="nitesh" dbms="oracle">
        <createIndex 
                indexName="idx_ditri_title"
                tableName="CATISSUE_DISTRIBUTION_PROTOCOL"
                unique="true">
            <column name="TITLE" type="varchar(512)"/>
        </createIndex>
    </changeSet>
    <changeSet id="adding autoIncrement for CATISSUE_DISTRIBUTION_PROTOCOL" author="nitesh" dbms="mysql">
        <addAutoIncrement columnDataType="${int.type}"
            columnName="IDENTIFIER"
            tableName="CATISSUE_DISTRIBUTION_PROTOCOL"/>
    </changeSet>
    <changeSet id="migrating data for distribution protocol for mysql" author="nitesh" dbms="mysql">
        <sql>update catissue_distribution_protocol dp join catissue_specimen_protocol sp on sp.identifier = dp.identifier
			set dp.PRINCIPAL_INVESTIGATOR_ID = sp.PRINCIPAL_INVESTIGATOR_ID,
			dp.TITLE=sp.TITLE,
			dp.SHORT_TITLE=sp.SHORT_TITLE,
			dp.IRB_IDENTIFIER=sp.IRB_IDENTIFIER,
			dp.START_DATE=sp.START_DATE,
			dp.END_DATE=sp.END_DATE,
			dp.ENROLLMENT=sp.ENROLLMENT,
			dp.DESCRIPTION_URL=sp.DESCRIPTION_URL,
			dp.ACTIVITY_STATUS=sp.ACTIVITY_STATUS where dp.identifier is not null
        </sql>
        <sql>commit;</sql>
    </changeSet>
    
    <changeSet id="migrating data for CATISSUE_DISTRIBUTION_PROTOCOL for oracle" author="nitesh" dbms="oracle">
        <sql>update (
            select dp.TITLE as cpTitle, sp.TITLE as spTitle,
            dp.SHORT_TITLE as cpSTitle, sp.SHORT_TITLE as spSTitle,
            dp.PRINCIPAL_INVESTIGATOR_ID as cpPID, sp.PRINCIPAL_INVESTIGATOR_ID as spPID,
            dp.IRB_IDENTIFIER as cpIrb, sp.IRB_IDENTIFIER as spIrb,
            dp.START_DATE as cpSDate, sp.START_DATE as spSDate,
            dp.END_DATE as cpEDate, sp.END_DATE as spEDate,
            dp.ENROLLMENT as cpEnrol, sp.ENROLLMENT as spEnroll,
            dp.DESCRIPTION_URL as cpUrl, sp.DESCRIPTION_URL as spUrl,
            dp.ACTIVITY_STATUS as cpAct, sp.ACTIVITY_STATUS as spAct from 
            CATISSUE_DISTRIBUTION_PROTOCOL dp join catissue_specimen_protocol sp on sp.identifier = dp.identifier
            where dp.identifier is not null
            ) up
            set up.cpTitle = up.spTitle,
            up.cpSTitle = up.spSTitle,
            up.cpPID = up.spPID,
            up.cpIrb = up.spIrb,
            up.cpSDate = up.spSDate,
            up.cpEDate = up.spEDate,
            up.cpEnrol = up.spEnroll,
            up.cpUrl = up.spUrl,
            up.cpAct = up.spAct;</sql>
      </changeSet>
    
    <changeSet id="adding columns for collection protocol" author="nitesh">
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="PRINCIPAL_INVESTIGATOR_ID" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="TITLE" type="${text.type}(512)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="SHORT_TITLE" type="${text.type}(512)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="IRB_IDENTIFIER" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="START_DATE" type="${date.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="END_DATE" type="${date.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="ENROLLMENT" type="${int.type}" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="DESCRIPTION_URL" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="ACTIVITY_STATUS" type="${text.type}(50)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="LABEL_FORMAT" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="DERIV_LABEL_FORMAT" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="ALIQUOT_LABEL_FORMAT" type="${text.type}(255)" />
        </addColumn>
        <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
            <column name="PPID_FORMAT" type="${text.type}(255)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="updating constraints for CATISSUE_COLLECTION_PROTOCOL" author="nitesh" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_COLLECTION_PROTOCOL" constraintName="FK32DC439DBC7298A9"/>
    </changeSet>
    
    <changeSet id="adding unique constraint for CP title" author="nitesh" dbms="mysql">
        <sql>ALTER TABLE CATISSUE_COLLECTION_PROTOCOL ADD CONSTRAINT idx_collection_prot_title UNIQUE (TITLE(255))</sql>
     </changeSet>
     
    <changeSet id="adding unique constraint for CP title" author="nitesh" dbms="oracle">
        <createIndex 
                indexName="idx_collection_prot_title"
                tableName="CATISSUE_COLLECTION_PROTOCOL"
                unique="true">
            <column name="TITLE" type="varchar(512)"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="adding autoIncrement for CATISSUE_COLLECTION_PROTOCOL" author="nitesh" dbms="mysql">
        <addAutoIncrement columnDataType="${int.type}"
            columnName="IDENTIFIER"
            tableName="CATISSUE_COLLECTION_PROTOCOL"/>
    </changeSet>
    
    <changeSet id="migrating data for CATISSUE_COLLECTION_PROTOCOL for mysql" author="nitesh" dbms="mysql">
        <sql>update catissue_collection_protocol cp join catissue_specimen_protocol sp on sp.identifier = cp.identifier
			set cp.PRINCIPAL_INVESTIGATOR_ID = sp.PRINCIPAL_INVESTIGATOR_ID,
			cp.TITLE=sp.TITLE,
			cp.SHORT_TITLE=sp.SHORT_TITLE,
			cp.IRB_IDENTIFIER=sp.IRB_IDENTIFIER,
			cp.START_DATE=sp.START_DATE,
			cp.END_DATE=sp.END_DATE,
			cp.ENROLLMENT=sp.ENROLLMENT,
			cp.DESCRIPTION_URL=sp.DESCRIPTION_URL,
			cp.ACTIVITY_STATUS=sp.ACTIVITY_STATUS,
			cp.LABEL_FORMAT=sp.LABEL_FORMAT,
			cp.DERIV_LABEL_FORMAT=sp.DERIV_LABEL_FORMAT,
			cp.ALIQUOT_LABEL_FORMAT=sp.ALIQUOT_LABEL_FORMAT,
			cp.PPID_FORMAT=sp.PPID_FORMAT where cp.identifier is not null
        </sql>
        <sql>commit;</sql>
    </changeSet>
    <changeSet id="migrating data for CATISSUE_COLLECTION_PROTOCOL for oracle" author="nitesh" dbms="oracle">
        <sql>update (
            select cp.TITLE as cpTitle, sp.TITLE as spTitle,
            cp.SHORT_TITLE as cpSTitle, sp.SHORT_TITLE as spSTitle,
            cp.PRINCIPAL_INVESTIGATOR_ID as cpPID, sp.PRINCIPAL_INVESTIGATOR_ID as spPID,
            cp.IRB_IDENTIFIER as cpIrb, sp.IRB_IDENTIFIER as spIrb,
            cp.START_DATE as cpSDate, sp.START_DATE as spSDate,
            cp.END_DATE as cpEDate, sp.END_DATE as spEDate,
            cp.ENROLLMENT as cpEnrol, sp.ENROLLMENT as spEnroll,
            cp.DESCRIPTION_URL as cpUrl, sp.DESCRIPTION_URL as spUrl,
            cp.ACTIVITY_STATUS as cpAct, sp.ACTIVITY_STATUS as spAct,
            cp.LABEL_FORMAT as cpLabel, sp.LABEL_FORMAT as spLabel,
            cp.DERIV_LABEL_FORMAT as cpDLabel, sp.DERIV_LABEL_FORMAT as spDLabel,
            cp.ALIQUOT_LABEL_FORMAT as cpALabel, sp.ALIQUOT_LABEL_FORMAT as spALabel,
            cp.PPID_FORMAT as cpPpid, sp.PPID_FORMAT as spPpid from 
            catissue_collection_protocol cp join catissue_specimen_protocol sp on sp.identifier = cp.identifier
            where cp.identifier is not null
            ) up
            set up.cpTitle = up.spTitle,
            up.cpSTitle = up.spSTitle,
            up.cpPID = up.spPID,
            up.cpIrb = up.spIrb,
            up.cpSDate = up.spSDate,
            up.cpEDate = up.spEDate,
            up.cpEnrol = up.spEnroll,
            up.cpUrl = up.spUrl,
            up.cpAct = up.spAct,
            up.cpLabel = up.spLabel,
            up.cpDLabel = up.spDLabel,
            up.cpALabel = up.spALabel,
            up.cpPpid = up.spPpid;</sql>
      </changeSet>
      
      <changeSet author="vinod" id="adding audit table"
		failOnError="true">
		<createTable tableName="CATISSUE_NEXTGEN_AUDIT_DETAILS">
			<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false"
					primaryKeyName="PK_CAT_NEXTGEN_AUDIT_DETAILS" />
			</column>

			<column name="OBJECT_TYPE" type="${text.type}(50)">
				<constraints nullable="false" />
			</column>

			<column name="OBJECT_ID" type="${int.type}">
				<constraints nullable="false" />
			</column>

			<column name="CP_ID" type="${int.type}">
			</column>

			<column name="OPERATION" type="${text.type}(15)">
				<constraints nullable="false" />
			</column>

			<column name="USER_ID" type="${int.type}">
				<constraints nullable="false" />
			</column>

			<column name="UPDATED_DATE" type="${timestamp.type}">
				<constraints nullable="false" />
			</column>

			<column name="REASON_FOR_CHANGE" type="${text.type}(500)">
			</column>

			<column name="IP_ADDRESS" type="${text.type}(15)">
				<constraints nullable="false" />
			</column>

		</createTable>
	</changeSet>

	<changeSet author="vinod" id="adding Sequence CATISSUE_NEXTGEN_AUDIT_DETAILS_SEQ" failOnError="true" dbms="oracle">
		<createSequence 
			sequenceName="CATISSUE_NEXTGEN_AUDIT_SEQ" 
			startValue="1" 
			incrementBy="1" 
			ordered="true" />
	</changeSet>

	<changeSet author="vinod" id="adding FK on USER_ID to users table" failOnError="true">
		<addForeignKeyConstraint 
			constraintName="FK_RE_USER_ID_USERS_ID"
			baseTableName="CATISSUE_NEXTGEN_AUDIT_DETAILS" 
			baseColumnNames="USER_ID"
			referencedTableName="CATISSUE_USER" 
			referencedColumnNames="IDENTIFIER" />
	</changeSet>

	<changeSet author="vinod" id="adding FK on CP_ID to COLLECTION_PROTOCOL table" failOnError="true">
		<addForeignKeyConstraint 
			constraintName="FK_AUDIT_CP_ID"
			baseTableName="CATISSUE_NEXTGEN_AUDIT_DETAILS" 
			baseColumnNames="CP_ID"
			referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
			referencedColumnNames="IDENTIFIER" />
	</changeSet>

	<changeSet author="vinod" id="creating index on OBJECT_TYPE" failOnError="false">
		<createIndex indexName="idx_audit_object_type" tableName="CATISSUE_NEXTGEN_AUDIT_DETAILS"
			unique="false">
			<column name="OBJECT_TYPE" type="${text.type}(50)" />
		</createIndex>
	</changeSet>

	<changeSet author="vinod" id="creating index on OBJECT_ID"
		failOnError="false">
		<createIndex indexName="idx_audit_object_id" tableName="CATISSUE_NEXTGEN_AUDIT_DETAILS"
			unique="false">
			<column name="OBJECT_ID" type="${int.type}" />
		</createIndex>
	</changeSet>


	<changeSet author="vinod" id="adding external application table" failOnError="true">
		<createTable tableName="CATISSUE_EXTERNAL_APPLICATION">
			<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" primaryKeyName="PK_CAT_EXTERNAL_APPLICATION"/>
			</column>

			<column name="APP_NAME" type="${text.type}(100)">
				<constraints nullable="false" />
			</column>

			<column name="SERVICE_CLASS" type="${text.type}(200)">
				<constraints nullable="false" />
			</column>

		</createTable>
	</changeSet>

	<changeSet author="vinod" id="adding Sequence CAT_EXTERNAL_APP_SEQ" failOnError="true" dbms="oracle">
		<createSequence sequenceName="CAT_EXTERNAL_APP_SEQ"
			startValue="1" incrementBy="1" ordered="true" />
	</changeSet>

	<changeSet author="vinod" id="adding CP and external app study mapping table" failOnError="true">
		<createTable tableName="CATISSUE_CP_EXTAPP_STUDY_REL">
			<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
				<constraints primaryKey="true" nullable="false" primaryKeyName="PK_CAT_CP_EXTAPP_STUDY_REL"/>
			</column>

			<column name="CP_ID" type="${int.type}">
				<constraints nullable="false" />
			</column>

			<column name="APP_ID" type="${int.type}">
				<constraints nullable="false" />
			</column>

			<column name="STUDY_ID" type="${text.type}(100)">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint 
			constraintName="FK_RE_APP_ID_FC_IDENTIFIER"
			baseTableName="CATISSUE_CP_EXTAPP_STUDY_REL" 
			baseColumnNames="APP_ID"
			referencedTableName="CATISSUE_EXTERNAL_APPLICATION"
			referencedColumnNames="IDENTIFIER" />

		<addForeignKeyConstraint 
			constraintName="FK_EXTAPP_CP_ID_FC_IDENTIFIER"
			baseTableName="CATISSUE_CP_EXTAPP_STUDY_REL" 
			baseColumnNames="CP_ID"
			referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
			referencedColumnNames="IDENTIFIER" />

	</changeSet>

	<changeSet author="vinod" id="adding Sequence CATISSUE_CP_EXTAPP_STUDY_REL_SEQ" failOnError="true" dbms="oracle">
		<createSequence 
			sequenceName="CAT_CP_EXTAPP_STUDY_REL_SEQ"
			startValue="1" 
			incrementBy="1" 
			ordered="true" />
	</changeSet>

	<changeSet author="vinod" id="adding Notification status table" failOnError="true">
		<createTable tableName="CATISSUE_NOTIFICATION_STATUS">
			<column name="AUDIT_ID" type="${int.type}">
				<constraints nullable="false" />
			</column>

			<column name="APP_ID" type="${int.type}">
				<constraints nullable="false" />
			</column>

			<column name="STATUS" type="${text.type}(15)">
				<constraints nullable="false" />
			</column>

			<column name="COMMENTS" type="${text.type}(500)">
			</column>
			
			<column name="NO_OF_ATTEMPTS" type="${int.type}">
			</column>
			
			<column name="UPDATED_DATE" type="${timestamp.type}">
				<constraints nullable="false" />
			</column>
			
		</createTable>

		<addForeignKeyConstraint 
			constraintName="FK_AUDIT_ID_FC_IDENTIFIER"
			baseTableName="CATISSUE_NOTIFICATION_STATUS" 
			baseColumnNames="AUDIT_ID"
			referencedTableName="CATISSUE_NEXTGEN_AUDIT_DETAILS"
			referencedColumnNames="IDENTIFIER" />

	</changeSet>   

    <changeSet author="vpawar" id="saved queries table" failOnError="true">
     	<createTable tableName="CATISSUE_SAVED_QUERIES"> 
          <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
            <constraints primaryKey="true" nullable="false"/>
          </column>

          <column name="TITLE" type="${text.type}(128)">
            <constraints nullable="false"/>
          </column>

          <column name="CREATED_BY" type="${int.type}">
            <constraints nullable="false"/>
          </column>

          <column name="LAST_UPDATED_BY" type="${int.type}">
            <constraints nullable="false"/>
          </column>

          <column name="LAST_UPDATED_ON" type="${timestamp.type}">
            <constraints nullable="false"/>
          </column>

          <column name="LAST_RUN_ON" type="${timestamp.type}">
            <constraints nullable="true"/>
          </column>

          <column name="LAST_RUN_COUNT" type="${int.type}">
            <constraints nullable="true"/>
          </column>

          <column name="QUERY_DEF" type="${clob.type}">
            <constraints nullable="false"/>
          </column>
      	</createTable>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key to saved queries (created_by)" failOnError="true">
        <addForeignKeyConstraint 
	  baseTableName="CATISSUE_SAVED_QUERIES"
          baseColumnNames="CREATED_BY"
	  referencedTableName="CATISSUE_USER"
	  referencedColumnNames="IDENTIFIER"
	  constraintName="FK_SAVED_QUERIES_CREATED_BY"/>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key to saved queries (last_updated_by)" failOnError="true">
        <addForeignKeyConstraint 
	  baseTableName="CATISSUE_SAVED_QUERIES"
          baseColumnNames="LAST_UPDATED_BY"
	  referencedTableName="CATISSUE_USER"
	  referencedColumnNames="IDENTIFIER"
	  constraintName="FK_SAVED_QUERIES_UPDATED_BY"/>
    </changeSet>

 <changeSet author="dpatil" id="inserting CATISSUE_AUTH_DOMAINS table" failOnError="true">
        <createTable tableName="CATISSUE_AUTH_DOMAINS">
            <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false" primaryKeyName="PK_DOMAIN_id"/>
            </column>
            <column name="DOMAIN_NAME" type="${text.type}(255)">
                <constraints unique="true" nullable="false" />
            </column>
            <column name="AUTH_TYPE" type="${text.type}(255)">
            </column>
        </createTable>
    </changeSet>  	  

    <changeSet author="dpatil" id="inserting auth domain sequence" failOnError="true" dbms="oracle">
        <createSequence
            sequenceName="CATISSUE_AUTH_DOMAIN_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
	</changeSet>  	    

    <changeSet author="dpatil" id="inserting CATISSUE_LDAP_DETAILS table" failOnError="true">
        <createTable tableName="CATISSUE_LDAP_DETAILS">
            <column name="DOMAIN_ID" type="${int.type}">
            </column>

            <column name="HOST" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>

            <column name="PORT" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>

            <column name="BIND_USER" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>
   
            <column name="BIND_PASSWORD" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>
           
            <column name="ID_FIELD" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>

	    <column name="SEARCH_BASE_DIR" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>

	    <column name="DIRECTORY_CONTEXT" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>	

	    <column name="FILTER_STRING" type="${text.type}(100)">
                <constraints nullable="false" />
            </column>

            <column name="SURNAME_FIELD" type="${text.type}(100)">
            </column>

            <column name="GIVEN_NAME_FIELD" type="${text.type}(100)">
            </column>

            <column name="EMAIL_FIELD" type="${text.type}(100)">
            </column>
        </createTable>

	<addForeignKeyConstraint constraintName="FK_domain_ID"
			baseTableName="CATISSUE_LDAP_DETAILS" baseColumnNames="DOMAIN_ID"
			referencedTableName="CATISSUE_AUTH_DOMAINS"
                        referencedColumnNames="IDENTIFIER" /> 

    </changeSet>  
    <changeSet id="inserting default catissue domain" author="dpatil" failOnError="false">
	<sql>INSERT INTO CATISSUE_AUTH_DOMAINS VALUES( 1,'catissue', 'catissue')</sql>
	<sql>INSERT INTO CATISSUE_AUTH_DOMAINS VALUES( 2,'ldap', 'ldap')</sql>
    </changeSet>

    <changeSet id="inserting Domain name column" author="dpatil" runOnChange="true">
	<addColumn tableName="CATISSUE_USER">
		<column name="DOMAIN_NAME" type="${text.type}(255)" defaultValue="catissue"/>
	</addColumn>
    </changeSet>
    
    <changeSet author="dpatil" id="inserting CATISSUE AUTH_PROVIDERS table" failOnError="true">
        
	<createTable tableName="CATISSUE_AUTH_PROVIDERS">
	    <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
                <constraints primaryKey="true" nullable="false" primaryKeyName="PK_Provider_id"/>
            </column>
	
            <column name="AUTH_TYPE" type="${text.type}(255)">
                <constraints unique="true" nullable="false" />
            </column>

            <column name="IMPL_CLASS" type="${text.type}(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

    </changeSet>

    <changeSet id="inserting default catissue auth providers" author="dpatil" failOnError="false">
<sql>INSERT INTO CATISSUE_AUTH_PROVIDERS VALUES(1,'catissue','com.krishagni.catissueplus.core.auth.services.impl.CatissueAuthServiceImpl')</sql>
<sql>INSERT INTO CATISSUE_AUTH_PROVIDERS VALUES(2,'ldap','com.krishagni.catissueplus.core.auth.services.impl.LdapAuthServiceImpl')</sql>
    </changeSet>	

    <changeSet author="dpatil" id="inserting foreignkey auth PROVIDER sequence" failOnError="true">
	<addForeignKeyConstraint constraintName="FK_provider_ID"
			baseTableName="CATISSUE_AUTH_DOMAINS" baseColumnNames="auth_type"
			referencedTableName="CATISSUE_AUTH_PROVIDERS"
                        referencedColumnNames="auth_type" /> 
	</changeSet>
	<changeSet author="dpatil" id="inserting auth PROVIDER sequence" failOnError="true" dbms="oracle">
        <createSequence
            sequenceName="CATISSUE_AUTH_PROVIDER_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
	</changeSet>  	  	   

    <changeSet author="vpawar" id="table for query folders" failOnError="true">
      <createTable tableName="CATISSUE_QUERY_FOLDERS">
        <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
          <constraints primaryKey="true" nullable="false"/>
        </column>

        <column name="NAME" type="${text.type}(64)">
          <constraints unique="true" nullable="false"/>
        </column>
 
        <column name="OWNER" type="${int.type}">
          <constraints nullable="false"/>
        </column>
      </createTable>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key constraint on owner field of query folders" failOnError="true">
      <addForeignKeyConstraint constraintName="CAT_QF_OWNER_CAT_USR_ID"
        baseTableName="CATISSUE_QUERY_FOLDERS" baseColumnNames="OWNER"
        referencedTableName="CATISSUE_USER" referencedColumnNames="IDENTIFIER" />
    </changeSet>

    <changeSet author="vpawar" id="table for mapping queries in folder" failOnError="true">
      <createTable tableName="CATISSUE_QUERY_FOLDER_QUERIES">
        <column name="FOLDER_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>
        <column name="QUERY_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>
      </createTable>
    </changeSet>

    <changeSet author="vpawar" id="add primary key constraints on query folder queries table" failOnError="true">
      <addPrimaryKey tableName="CATISSUE_QUERY_FOLDER_QUERIES" columnNames="FOLDER_ID, QUERY_ID"/>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key on folder field of folder queries table" failOnError="true">
      <addForeignKeyConstraint constraintName="CAT_QFQ_FOLDER_ID_CAT_QF_ID"
        baseTableName="CATISSUE_QUERY_FOLDER_QUERIES" baseColumnNames="FOLDER_ID"
        referencedTableName="CATISSUE_QUERY_FOLDERS" referencedColumnNames="IDENTIFIER"/>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key on query field of folder queries table" failOnError="true">
      <addForeignKeyConstraint constraintName="CAT_QFQ_QUERY_ID_CAT_SQ_ID"
        baseTableName="CATISSUE_QUERY_FOLDER_QUERIES" baseColumnNames="QUERY_ID"
        referencedTableName="CATISSUE_SAVED_QUERIES" referencedColumnNames="IDENTIFIER"/>
    </changeSet>

    <changeSet author="vpawar" id="table for mapping users sharing folder" failOnError="true">
      <createTable tableName="CATISSUE_QFOLDER_SHARE_SETTING">
        <column name="FOLDER_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>
        <column name="USER_ID" type="${int.type}">
          <constraints nullable="false"/>
        </column>
      </createTable>
    </changeSet>

    <changeSet author="vpawar" id="add primary key of query folder share settings table" failOnError="true">
      <addPrimaryKey tableName="CATISSUE_QFOLDER_SHARE_SETTING" columnNames="FOLDER_ID, USER_ID"/>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key on folder field of share settings table" failOnError="true">
      <addForeignKeyConstraint constraintName="CAT_QFSS_FOLDER_ID_CAT_QF_ID"
        baseTableName="CATISSUE_QFOLDER_SHARE_SETTING" baseColumnNames="FOLDER_ID"
        referencedTableName="CATISSUE_QUERY_FOLDERS" referencedColumnNames="IDENTIFIER"/>
    </changeSet>

    <changeSet author="vpawar" id="add foreign key on user field of share settings table" failOnError="true">
      <addForeignKeyConstraint constraintName="CAT_QFSS_USER_ID_CAT_USR_ID"
        baseTableName="CATISSUE_QFOLDER_SHARE_SETTING" baseColumnNames="USER_ID"
        referencedTableName="CATISSUE_USER" referencedColumnNames="IDENTIFIER"/>
    </changeSet>
    
    <changeSet author="ka" id="adding Sequence CATISSUE_FORM_CONTEXT" failOnError="true" dbms="oracle">
	  <createSequence 
        sequenceName="CATISSUE_FORM_CONTEXT_SEQ" 
        startValue="1" 
        incrementBy="1" 
        ordered="true" />
	</changeSet>
    
    <changeSet author="ka" id="adding Sequence CATISSUE_FORM_REC_ENTRY_SEQ" failOnError="true" dbms="oracle">
	  <createSequence 
        sequenceName="CATISSUE_FORM_REC_ENTRY_SEQ" 
        startValue="1" 
        incrementBy="1" 
        ordered="true" />
    </changeSet>
    <changeSet author="ka" id="updating FK for specimen list to refer specimen table" failOnError="false">
    <dropForeignKeyConstraint baseTableName="catissue_spec_tag_items" constraintName="FK_SPECLIST_OBJ_ID"/>
    <addForeignKeyConstraint constraintName="FK_SPECLIST_OBJ_ID"
            baseTableName="catissue_spec_tag_items" baseColumnNames="OBJ_ID" referencedTableName="catissue_specimen"
            referencedColumnNames="IDENTIFIER" />
    </changeSet>
	<changeSet  author="Mosin" id="Updating SQ metadata" failOnError="false">
		<sql>delete from CATISSUE_QUERY_TABLE_DATA where table_id = 9</sql>
		<sql>update CATISSUE_INTERFACE_COLUMN_DATA set table_id =10 where table_id = 9</sql>
		<sql>delete from CATISSUE_TABLE_RELATION where parent_table_id = 10 and child_table_id = 9</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set relationship_id = 12 where relationship_id = 13</sql>
		<sql>delete from CATISSUE_TABLE_RELATION where relationship_id = 40</sql>
		<sql>delete from  CATISSUE_SEARCH_DISPLAY_DATA where relationship_id = 40</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (347,19,'TITLE','varchar')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (348,19,'SHORT_TITLE','varchar')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (349,19,'IRB_IDENTIFIER','varchar')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (350,19,'START_DATE','date')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (351,19,'END_DATE','date')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (352,19,'ENROLLMENT','integer')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (353,19,'DESCRIPTION_URL','varchar')</sql>
		<sql>insert into CATISSUE_INTERFACE_COLUMN_DATA values (354,19,'ACTIVITY_STATUS','varchar')</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 347,RELATIONSHIP_ID = 17 where  RELATIONSHIP_ID = 18 and COL_ID = 224</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 348,RELATIONSHIP_ID = 17  where  RELATIONSHIP_ID = 18 and COL_ID = 225</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 349,RELATIONSHIP_ID = 17  where  RELATIONSHIP_ID = 18 and COL_ID = 226</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 350,RELATIONSHIP_ID = 17  where  RELATIONSHIP_ID = 18 and COL_ID = 227</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 351,RELATIONSHIP_ID = 17  where  RELATIONSHIP_ID = 18 and COL_ID = 228</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 352,RELATIONSHIP_ID = 17  where  RELATIONSHIP_ID = 18 and COL_ID = 229</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set COL_ID = 353,RELATIONSHIP_ID = 17  where  RELATIONSHIP_ID = 18 and COL_ID = 230</sql>
		<sql>delete from CATISSUE_TABLE_RELATION where relationship_id = 43</sql>
		<sql>delete from  CATISSUE_SEARCH_DISPLAY_DATA where relationship_id = 43</sql>
		<sql>update CATISSUE_INTERFACE_COLUMN_DATA set table_id =33 where table_id in (100,99,34)</sql>
		<sql>delete from CATISSUE_TABLE_RELATION where parent_table_id = 33 and child_table_id in (100,99,34)</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set relationship_id = 34 where relationship_id in (146,147,35)</sql>
		<sql>update CATISSUE_SEARCH_DISPLAY_DATA set relationship_id = 30 where relationship_id = 137</sql>
		<sql>update CATISSUE_INTERFACE_COLUMN_DATA set table_id = 35 where table_id = 92</sql>
		<sql>delete from CATISSUE_TABLE_RELATION where parent_table_id = 35 and child_table_id = 92</sql>
    </changeSet>
    <changeSet id="droping unused tables" author="nitesh" failOnError="false">
        <dropTable cascadeConstraints="true" tableName="catissue_specimen_protocol"/>
        <dropTable cascadeConstraints="true" tableName="catissue_abstract_specimen"/>
        <dropTable cascadeConstraints="true" tableName="catissue_abs_speci_coll_group"/>
        <dropTable cascadeConstraints="true" tableName="catissue_specimen_char"/>
    </changeSet>

    <changeSet author="dpatil" id="table for catissue_roles" failOnError="true">
   	<createTable tableName="CATISSUE_ROLES">
            	<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
               		<constraints primaryKey="true" nullable="false" primaryKeyName="PK_CAT_ROLE_ID"/>
            	</column>
   
            	<column name="NAME" type="${text.type}(64)">
                	<constraints unique="true" nullable="false" />
            	</column>

        	<column name="DESCRIPTION" type="${text.type}(255)">
     	       	</column>
         </createTable>
    </changeSet>

    <changeSet author="dpatil" id="table for catissue privileges" failOnError="true">
	<createTable tableName="CATISSUE_PRIVILEGES">
		<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
			<constraints primaryKey="true" nullable="false" primaryKeyName="PK_CAT_PRIVILEGE_ID"/>
		</column>
	   
		<column name="PRIVILEGE" type="${text.type}(64)">
			<constraints unique="true" nullable="false" />
		</column>
	</createTable>
    </changeSet>

    <changeSet author="dpatil" id="table for catissue collection protocol site roles" failOnError="true">
	<createTable tableName="CATISSUE_CP_SITE_ROLES">
	       	<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
	       		<constraints primaryKey="true" nullable="false" primaryKeyName="PK_CAT_CPSITEROLE_ID"/>
	    	</column>
	   
		<column name="CP_ID" type="${int.type}">
		</column>

		<column name="SITE_ID" type="${int.type}">
		</column>
	   
		    <column name="ROLE_ID" type="${int.type}">
		</column>
	</createTable>
	    
	<addForeignKeyConstraint
		constraintName="FK_CAT_CSR_CPID_CAT_CP_ID"
		baseTableName="CATISSUE_CP_SITE_ROLES"
		baseColumnNames="CP_ID"
		referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
		referencedColumnNames="IDENTIFIER" />
	<addForeignKeyConstraint
		constraintName="FK_CAT_CSR_SITEID_CAT_SITE_ID"
		baseTableName="CATISSUE_CP_SITE_ROLES"
		baseColumnNames="SITE_ID"
		referencedTableName="CATISSUE_SITE"
		referencedColumnNames="IDENTIFIER" />
	<addForeignKeyConstraint
		constraintName="FK_CAT_CSR_ROLEID_CAT_ROLE_ID"
		baseTableName="CATISSUE_CP_SITE_ROLES"
		baseColumnNames="ROLE_ID"
		referencedTableName="CATISSUE_ROLES"
		referencedColumnNames="IDENTIFIER" />
    </changeSet>

    <changeSet author="dpatil" id="table for catissue user site roles" failOnError="true">
	<createTable tableName="CATISSUE_USER_SITES">
		<column name="USER_ID" type="${int.type}">
		</column>

		<column name="SITE_ID" type="${int.type}">
		</column>
	</createTable>
    
	<addForeignKeyConstraint
		constraintName="FK_CAT_US_USERID_CAT_USER_ID"
		baseTableName="CATISSUE_USER_SITES"
		baseColumnNames="USER_ID"
		referencedTableName="CATISSUE_USER"
		referencedColumnNames="IDENTIFIER" />
	<addForeignKeyConstraint
		constraintName="FK_CAT_US_SITEID_CAT_SITE_ID"
		baseTableName="CATISSUE_USER_SITES"
		baseColumnNames="SITE_ID"
		referencedTableName="CATISSUE_SITE"
		referencedColumnNames="IDENTIFIER" />
    </changeSet>

    <changeSet author="dpatil" id="table for catissue cp user roles" failOnError="true">
	<createTable tableName="CATISSUE_CP_USER_ROLES">
		<column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
		       <constraints primaryKey="true" nullable="false" primaryKeyName="PK_CAT_CPUSERROLE_ID"/>
		</column>
	   
		<column name="CP_ID" type="${int.type}">
		</column>

		<column name="USER_ID" type="${int.type}">
		</column>
	   
		<column name="ROLE_ID" type="${int.type}">
		</column>
	</createTable>
	<addForeignKeyConstraint
		constraintName="FK_CAT_CUR_CPID_CAT_CP_ID"
		baseTableName="CATISSUE_CP_USER_ROLES"
		baseColumnNames="CP_ID"
		referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
		referencedColumnNames="IDENTIFIER" />
	<addForeignKeyConstraint
		constraintName="FK_CAT_CUR_USERID_CAT_USER_ID"
		baseTableName="CATISSUE_CP_USER_ROLES"
		baseColumnNames="USER_ID"
		referencedTableName="CATISSUE_USER"
		referencedColumnNames="IDENTIFIER" />

	<addForeignKeyConstraint
		constraintName="FK_CAT_CUR_ROLEID_CAT_ROLES_ID"
		baseTableName="CATISSUE_CP_USER_ROLES"
		baseColumnNames="ROLE_ID"
		referencedTableName="CATISSUE_ROLES"
		referencedColumnNames="IDENTIFIER" />
    </changeSet>

    <changeSet author="dpatil" id="table for role privilege mappings" failOnError="true">
	<createTable tableName="CATISSUE_ROLE_PRIVILEGES">
		<column name="PRIVILEGE_ID" type="${int.type}">
		</column>

		<column name="ROLE_ID" type="${int.type}">
		</column>
	</createTable>

	<addPrimaryKey
		columnNames="PRIVILEGE_ID, ROLE_ID"
		constraintName="PK_CAT_RP_ROLEID_PRIVID"
		tableName="CATISSUE_ROLE_PRIVILEGES"/>

	<addForeignKeyConstraint
		constraintName="FK_CAT_RP_ROLEID_CAT_ROLES_ID"
		baseTableName="CATISSUE_ROLE_PRIVILEGES"
		baseColumnNames="ROLE_ID"
		referencedTableName="CATISSUE_ROLES"
		referencedColumnNames="IDENTIFIER" />

	<addForeignKeyConstraint
		constraintName="FK_CAT_RP_PRIVID_CAT_PRIV_ID"
		baseTableName="CATISSUE_ROLE_PRIVILEGES"
		baseColumnNames="PRIVILEGE_ID"
		referencedTableName="CATISSUE_PRIVILEGES"
		referencedColumnNames="IDENTIFIER" />
    </changeSet>

    <changeSet author="dpatil" id="inserting user cp role sequence" failOnError="true" dbms="oracle">
        <createSequence
            sequenceName="CATISSUE_USER_CP_ROLE_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
	</changeSet> 

    <changeSet author="dpatil" id="inserting cp site role sequence" failOnError="true" dbms="oracle">
        <createSequence
            sequenceName="CATISSUE_CP_SITE_ROLE_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
    </changeSet>

    <changeSet author="dpatil" id="inserting role sequence" failOnError="true" dbms="oracle">
        <createSequence
            sequenceName="CATISSUE_ROLE_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
    </changeSet> 

    <changeSet author="dpatil" id="inserting privilege sequence" failOnError="true" dbms="oracle">
        <createSequence
            sequenceName="CATISSUE_PRIVILEGE_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
    </changeSet>  

   <changeSet id="sqls to add default privileges" author="dpatil" failOnError="false">
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (1,'ACCESS') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (2,'ASSIGN_READ') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (3,'ASSIGN_USE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (4,'CREATE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (5,'DEFINE_ANNOTATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (6,'DELETE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (7,'EXECUTE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (8,'GENERAL_ADMINISTRATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (9,'DISTRIBUTION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (10,'GENERAL_SITE_ADMINISTRATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (11,'IDENTIFIED_DATA_ACCESS') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (12,'PARTICIPANT_SCG_ANNOTATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (13,'PHI_ACCESS') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (14,'PROTOCOL_ADMINISTRATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (15,'QUERY') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (16,'READ') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (17,'READ_DENIED') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (18,'REGISTRATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (19,'REPOSITORY_ADMINISTRATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (20,'SHIPMENT_PROCESSING') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (21,'SPECIMEN_ACCESSION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (22,'SPECIMEN_ANNOTATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (23,'SPECIMEN_PROCESSING') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (24,'SPECIMEN_STORAGE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (25,'STORAGE_ADMINISTRATION') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (26,'UPDATE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (27,'USE') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (28,'USER_PROVISIONING') </sql>
    <sql> insert into CATISSUE_PRIVILEGES (IDENTIFIER, PRIVILEGE) values (29,'WRITE') </sql>    
   </changeSet>
   
    <changeSet author="ajay" id="modify data type for sequence ID column" dbms="mysql">
		<modifyDataType columnName="KEY_SEQUENCE_ID" newDataType="${int.type}" tableName="key_seq_generator"/>
	</changeSet>
	<changeSet author="nitesh" id="modify data type for sequence ID column" dbms="oracle">
        <addColumn tableName="key_seq_generator">
            <column name="KEY_SEQUENCE_ID_TMP" type="${int.type}" />
        </addColumn>
        <sql>
            update key_seq_generator set KEY_SEQUENCE_ID_TMP=KEY_SEQUENCE_ID;
        </sql>
        <sql>commit;</sql>
        <dropColumn columnName="KEY_SEQUENCE_ID" tableName="key_seq_generator"/>
        <renameColumn columnDataType="${int.type}" newColumnName="KEY_SEQUENCE_ID" oldColumnName="KEY_SEQUENCE_ID_TMP" tableName="key_seq_generator"/>
    </changeSet>

    <changeSet author="vpawar" id="adding saved queries sequence" failOnError="true" dbms="oracle">
      <createSequence 
        sequenceName="CATISSUE_SAVED_QUERIES_SEQ" 
        startValue="1" 
        incrementBy="1" 
        ordered="true"/>
    </changeSet>

    <changeSet author="vpawar" id="adding query folders sequence" failOnError="true" dbms="oracle">
      <createSequence 
        sequenceName="CATISSUE_QUERY_FOLDERS_SEQ" 
        startValue="1" 
        incrementBy="1" 
        ordered="true"/>
    </changeSet>

    <changeSet author="vpawar" id="query audit logs sequence" failOnError="true" dbms="oracle">
      <createSequence 
        sequenceName="CATISSUE_QUERY_AUDIT_LOGS_SEQ" 
        startValue="1" 
        incrementBy="1" 
        ordered="true"/>
    </changeSet>

    <changeSet author="vpawar" id="query audit logs table" failOnError="true">
       <createTable tableName="CATISSUE_QUERY_AUDIT_LOGS">
         <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
           <constraints primaryKey="true" nullable="false"/>
         </column>

         <column name="QUERY_ID" type="${int.type}">
         </column>

         <column name="RUN_BY" type="${int.type}">
           <constraints nullable="false"/>
         </column>

         <column name="TIME_OF_EXEC" type="${timestamp.type}">
           <constraints nullable="false"/>
         </column>

         <column name="TIME_TO_FINISH" type="${mediumint.type}">
           <constraints nullable="false"/>
         </column>

         <column name="RUN_TYPE" type="${text.type}(16)">
           <constraints nullable="false"/>
         </column>

         <column name="RECORD_COUNT" type="${int.type}">
         </column>

         <column name="QUERY_SQL" type="${clob.type}">
           <constraints nullable="false"/>
         </column>
       </createTable>
    </changeSet>

    <changeSet author="vpawar" id="fk on query id of audit log" failOnError="true">
       <addForeignKeyConstraint
               constraintName="FK_QAUDIT_LOG_QID_QUERIES_ID"
               baseTableName="CATISSUE_QUERY_AUDIT_LOGS"
               baseColumnNames="QUERY_ID"
               referencedTableName="CATISSUE_SAVED_QUERIES"
               referencedColumnNames="IDENTIFIER" />
    </changeSet>

    <changeSet author="vpawar" id="fk on run by of audit log" failOnError="true">
       <addForeignKeyConstraint
               constraintName="FK_QAUDIT_LOG_RUN_BY_USERS_ID"
               baseTableName="CATISSUE_QUERY_AUDIT_LOGS"
               baseColumnNames="RUN_BY"
               referencedTableName="CATISSUE_USER"
               referencedColumnNames="IDENTIFIER" />
    </changeSet>
        <changeSet author="nitesh" id="drop foreign key constraint from CATISSUE_CONSENT_TIER_STATUS" failOnError="false">
        <dropForeignKeyConstraint baseTableName="CATISSUE_CONSENT_TIER_STATUS" constraintName="FKF74E94AEF69249F7"/>
        <dropForeignKeyConstraint baseTableName="CATISSUE_CONSENT_TIER_STATUS" constraintName="FKF74E94AE60773DB2"/>
    </changeSet>
    <changeSet id="procedure to enable/disable foreign key constraints" author="nitesh" dbms="oracle">
      <sql splitStatements="false" endDelimiter="$">
       CREATE OR REPLACE
        PROCEDURE DISABLECONSTRAINT AS
        cnt number:=0;
        BEGIN
          
          FOR c IN
          (SELECT c.owner, c.table_name, c.constraint_name, c.CONSTRAINT_TYPE
           FROM user_constraints c, user_tables t
           WHERE c.table_name = t.table_name
           AND c.status = 'ENABLED' and c.constraint_type='R')
          LOOP
          cnt:=cnt+1;
            dbms_output.put_line(cnt||' Constraint:   '||c.constraint_name ||' Table'|| c.table_name);
            execute immediate 'alter table '||c.table_name||' disable constraint '||c.constraint_name||'';
          END LOOP;
          commit;
        END DISABLECONSTRAINT;
    </sql>
    <sql splitStatements="false" endDelimiter="$">
       CREATE OR REPLACE
        PROCEDURE ENABLECONSTRAINT AS
        cnt number:=0;
        BEGIN
          
          FOR c IN
          (SELECT c.owner, c.table_name, c.constraint_name, c.CONSTRAINT_TYPE
           FROM user_constraints c, user_tables t
           WHERE c.table_name = t.table_name
           AND c.status = 'DISABLED' and c.constraint_type='R')
          LOOP
          cnt:=cnt+1;
            dbms_output.put_line(cnt||' Constraint:   '||c.constraint_name ||' Table'|| c.table_name);
            execute immediate 'alter table '||c.table_name||' enable constraint '||c.constraint_name||'';
          END LOOP;
          commit;
        END ENABLECONSTRAINT;
    </sql>
    </changeSet>
    <!-- <changeSet id="for deleting the anticipated SCG's having anticipated specimens" author="nitesh">

       <sql>
            create table catissue_tmp_scg as select * from (
            select * from catissue_specimen_coll_group where identifier 
                        
            NOT IN
            
            (select distinct scg.identifier from catissue_specimen_coll_group scg join catissue_specimen sp on sp.SPECIMEN_COLLECTION_GROUP_ID = scg.identifier
            where scg.COLLECTION_STATUS = 'Pending' and sp.COLLECTION_STATUS ='Pending'
            and scg.identifier not in (select SPECIMEN_COLLECTION_GROUP_ID from catissue_specimen where COLLECTION_STATUS = 'Collected')
            ))t1
       </sql>
        <addPrimaryKey tableName="catissue_tmp_scg" columnNames="IDENTIFIER"/>
     
       <sql>
            create table catissue_tmp_specimen  as select * from catissue_specimen  where SPECIMEN_COLLECTION_GROUP_ID in(
            select identifier from catissue_tmp_scg)
       </sql>
         <addPrimaryKey tableName="catissue_tmp_specimen" columnNames="IDENTIFIER"/>
       <sql>
            create table catissue_tmp_ex_id as select ex.* from CATISSUE_EXTERNAL_IDENTIFIER ex join 
            catissue_tmp_specimen sp on ex.specimen_id = sp.identifier where sp.identifier is not null
       </sql>
       <sql>commit;</sql>
    </changeSet>
    <changeSet id="disable constraints" author="nitesh" dbms="oracle">   
        <sql>call DISABLECONSTRAINT()</sql>
    </changeSet>
    
    <changeSet author="nitesh" id="disable constraints" failOnError="false" dbms="mysql">
        <sql>SET FOREIGN_KEY_CHECKS=0;</sql>
    </changeSet>
    
    <changeSet id="Delete original scg/specimen tables and rename the temp" author="nitesh" >
        <dropTable tableName="catissue_specimen" cascadeConstraints="true"/>
        <dropTable tableName="catissue_specimen_coll_group" cascadeConstraints="true"/>
        <dropTable tableName="CATISSUE_EXTERNAL_IDENTIFIER" cascadeConstraints="true"/>

        <renameTable newTableName="catissue_specimen_coll_group" oldTableName="catissue_tmp_scg" />
        <renameTable newTableName="catissue_specimen" oldTableName="catissue_tmp_specimen" />
        <renameTable newTableName="CATISSUE_EXTERNAL_IDENTIFIER" oldTableName="catissue_tmp_ex_id" />
    </changeSet>
    
    <changeSet id="enable constraints" author="nitesh" dbms="oracle">
        <sql>call ENABLECONSTRAINT()</sql>
    </changeSet>
    
    <changeSet author="nitesh" id="enable constraints" failOnError="false" dbms="mysql">
        <sql>SET FOREIGN_KEY_CHECKS=1;</sql>
    </changeSet>
    
    <changeSet id="creating constraints for specimen table" author="nitesh">
     
    <addForeignKeyConstraint baseColumnNames="SPECIMEN_COLLECTION_GROUP_ID"
                   baseTableName="CATISSUE_SPECIMEN"
                   constraintName="FK1674810433BF33C5"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_SPECIMEN_COLL_GROUP"/>
                           
     <addForeignKeyConstraint baseColumnNames="REQ_SPECIMEN_ID"
                   baseTableName="CATISSUE_SPECIMEN"
                   constraintName="FK_REQ_SPECIMEN_ID"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_CP_REQ_SPECIMEN"/>
     <addForeignKeyConstraint baseColumnNames="PARENT_SPECIMEN_ID"
                   baseTableName="CATISSUE_SPECIMEN"
                   constraintName="FK_PARENT_SPECIMEN"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_SPECIMEN"/>
     
        <createIndex 
                indexName="idx_specimen_class"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="SPECIMEN_CLASS" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="idx_specimen_type"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="SPECIMEN_TYPE" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="idx_pathology_stat"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="PATHOLOGICAL_STATUS" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="idx_init_quantity"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="INITIAL_QUANTITY" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="idx_specimen_lineage"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="LINEAGE" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="idx_unq_specimen_label"
                tableName="CATISSUE_SPECIMEN"
                unique="true">
            <column name="LABEL" type="varchar(255)"/>
        </createIndex>
        <createIndex 
                indexName="idx_unq_specimen_barcode"
                tableName="CATISSUE_SPECIMEN"
                unique="true">
            <column name="BARCODE" type="varchar(255)"/>
        </createIndex>
        <createIndex 
                indexName="CATISSUE_SPECIMEN_ACT_STAT"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="ACTIVITY_STATUS" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="CATISSUE_SPECIMEN_COLL_STAT"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="COLLECTION_STATUS" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="INDX_CATISSUE_SPECIMEN_AVQTY"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="AVAILABLE_QUANTITY" type="varchar(50)"/>
        </createIndex>
    </changeSet> -->
    <changeSet id="adding index for parent_specimen_id" author="nitesh" failOnError="false">
		<createIndex 
                indexName="INDX_CAT_PARENT_SPECIMEN"
                tableName="CATISSUE_SPECIMEN"
                unique="false">
            <column name="PARENT_SPECIMEN_ID" type="${int.type}"/>
        </createIndex>
	</changeSet>
    <!-- <changeSet id="creating constraints for SCG table" author="nitesh">
    
    <addForeignKeyConstraint baseColumnNames="COLLECTION_PROTOCOL_REG_ID"
                   baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
                   constraintName="FKDEBAF1677E07C4AC"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_COLL_PROT_REG"/>
                           
     <addForeignKeyConstraint baseColumnNames="COLLECTION_PROTOCOL_EVENT_ID"
                   baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
                   constraintName="FKDEBAF16753B01F66"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_COLL_PROT_EVENT"/>
     <addForeignKeyConstraint baseColumnNames="COLLECTOR_ID"
                   baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
                   constraintName="FK_USER_EVENT_MAPPING"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_USER"/>
     <addForeignKeyConstraint baseColumnNames="RECEIVER_ID"
                   baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
                   constraintName="FK_RECEIVER_ID_SCG"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_USER"/>
     <addForeignKeyConstraint baseColumnNames="SITE_ID"
                   baseTableName="CATISSUE_SPECIMEN_COLL_GROUP"
                   constraintName="FK_SITE_ID_SCG"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="CATISSUE_SITE"/>
     
        <createIndex 
                indexName="idx_unique_scg_name"
                tableName="CATISSUE_SPECIMEN_COLL_GROUP"
                unique="true">
            <column name="NAME" type="varchar(255)"/>
        </createIndex>
        <createIndex 
                indexName="idx_unique_scg_barcode"
                tableName="CATISSUE_SPECIMEN_COLL_GROUP"
                unique="true">
            <column name="BARCODE" type="varchar(255)"/>
        </createIndex>
        
        <createIndex 
                indexName="CATISSUE_SPC_COL_GRP_COL_STAT"
                tableName="CATISSUE_SPECIMEN_COLL_GROUP"
                unique="false">
            <column name="COLLECTION_STATUS" type="varchar(50)"/>
        </createIndex>
        <createIndex 
                indexName="CATISSUE_SPEC_COLL_GRP_CPE_ID"
                tableName="CATISSUE_SPECIMEN_COLL_GROUP"
                unique="false">
            <column name="COLLECTION_PROTOCOL_EVENT_ID" type="varchar(50)"/>
        </createIndex>            
        <createIndex 
                indexName="CATISSUE_SPEC_COLL_GRP_CPR_ID"
                tableName="CATISSUE_SPECIMEN_COLL_GROUP"
                unique="false">
            <column name="COLLECTION_PROTOCOL_REG_ID" type="varchar(50)"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="creating constraints for external identifier" author="nitesh">
        
        <addPrimaryKey tableName="catissue_external_identifier" columnNames="IDENTIFIER"/>
    
        <addForeignKeyConstraint baseColumnNames="SPECIMEN_ID"
                   baseTableName="catissue_external_identifier"
                   constraintName="FK5CF2FA2160773DB2"
                   referencedColumnNames="IDENTIFIER"
                   referencedTableName="catissue_specimen"/>
    </changeSet>
    
    <changeSet id="adding autoIncrement for specimen, SCG and external-id" author="nitesh" dbms="mysql">
        <addAutoIncrement columnDataType="${int.type}"
            columnName="IDENTIFIER"
            tableName="catissue_external_identifier"/>
        <addAutoIncrement columnDataType="${int.type}"
            columnName="IDENTIFIER"
            tableName="CATISSUE_SPECIMEN_COLL_GROUP"/>
        <addAutoIncrement columnDataType="${int.type}"
            columnName="IDENTIFIER"
            tableName="CATISSUE_SPECIMEN"/>
    </changeSet>     -->

    <changeSet id="delete orphan references from specimen list table" author="nitesh">
        <sql>
            delete from CATISSUE_SPEC_TAG_ITEMS where obj_id not in (select identifier from catissue_specimen)
        </sql>
        <sql>commit;</sql>
    </changeSet>
    
    <!-- <changeSet id="delete entries from event tables for SCG" author="nitesh">
        <sql>
            delete from catissue_received_event_param where identifier in(
                select identifier from (
                    select sep.identifier as identifier from catissue_specimen_event_param sep join catissue_received_event_param cpe on cpe.identifier = sep.identifier
                    where sep.specimen_coll_grp_id in (select identifier from catissue_specimen_coll_group)
                )t
            )
        </sql>
        <sql>
            delete from catissue_coll_event_param where identifier in(
                select identifier from (
                    select sep.identifier as identifier from catissue_specimen_event_param sep join catissue_coll_event_param cpe on cpe.identifier = sep.identifier
                    where sep.specimen_coll_grp_id in (select identifier from catissue_specimen_coll_group)
                )t
            )
        </sql>
        <sql>
            delete from catissue_specimen_event_param where specimen_coll_grp_id in (select identifier from catissue_specimen_coll_group)
        </sql>
        <sql>commit;</sql>
    </changeSet>
    
    <changeSet id="delete entries from event tables for Specimen requirement" author="nitesh">
        <sql>
            delete from catissue_received_event_param where identifier in(
                select identifier from (
                    select sep.identifier as identifier from catissue_specimen_event_param sep join catissue_received_event_param cpe on cpe.identifier = sep.identifier
                    where sep.specimen_id in (select identifier from catissue_cp_req_specimen)
                )t
            )
        </sql>
        <sql>
            delete from catissue_coll_event_param where identifier in(
                select identifier from (
                    select sep.identifier as identifier from catissue_specimen_event_param sep join catissue_coll_event_param cpe on cpe.identifier = sep.identifier
                    where sep.specimen_id in (select identifier from catissue_cp_req_specimen)
                )t
            )
        </sql>
        <sql>
            delete from catissue_specimen_event_param where specimen_id in (select identifier from catissue_cp_req_specimen)
        </sql>
        <sql>commit;</sql>
    </changeSet> -->

  
    <changeSet author="mibrahim" id="CREATE SPECIMEN HIERARCHY TABLE" failOnError="true">
      <createTable tableName="CATISSUE_SPECIMEN_HIERARCHY">
        <column name="ANCESTOR_ID" type="${int.type}">
        </column>
        
        <column name="DESCENDENT_ID" type="${int.type}">
        </column>
      </createTable>
    </changeSet>

    <changeSet id="CREATE SPECIMEN HIERARCHY MYSQL" author="mibrahim" runOnChange="true" dbms="mysql">
      <sqlFile 
        encoding="utf8"
        path="create_specimen_hierarchy_mysql.sql"
        relativeToChangelogFile="true"
        endDelimiter="//"
        splitStatements="true"
        stripComments="true"/>
    </changeSet>

    <changeSet id="CREATE SPECIMEN HIERARCHY ORACLE" author="mibrahim" runOnChange="true" dbms="oracle">
      <sql>delete from CATISSUE_SPECIMEN_HIERARCHY</sql>

      <sql>commit;</sql>

      <sqlFile 
        encoding="utf8"
        path="create_specimen_hierarchy_oracle.sql"
        relativeToChangelogFile="true"
        endDelimiter="/"
        splitStatements="true"
        stripComments="true"/>

      <sql>call migrate()</sql>

      <sql>commit;</sql>
    </changeSet>

    <changeSet id="CREATE SPECIMEN HIERARCHY CONSTRAINTS ORACLE" author="mibrahim" runOnChange="true" dbms="oracle">
      <addForeignKeyConstraint 
			constraintName="FK_ANCESTOR_ID_MAP"
			baseTableName="CATISSUE_SPECIMEN_HIERARCHY" 
			baseColumnNames="ANCESTOR_ID"
			referencedTableName="CATISSUE_SPECIMEN" 
			referencedColumnNames="IDENTIFIER" />

      <addForeignKeyConstraint 
			constraintName="FK_DESCENDENT_ID_MAP"
			baseTableName="CATISSUE_SPECIMEN_HIERARCHY" 
			baseColumnNames="DESCENDENT_ID"
			referencedTableName="CATISSUE_SPECIMEN" 
			referencedColumnNames="IDENTIFIER" />

      <addUniqueConstraint 
			constraintName="UK_ANCESTOR_DESCENDENT"
			tableName="CATISSUE_SPECIMEN_HIERARCHY" 
			columnNames="ANCESTOR_ID,DESCENDENT_ID" />

    </changeSet>
   
    <changeSet id="CREATE SPECIMEN REPLICATION TRIGGER ORACLE" author="mibrahim" runOnChange="true" dbms="oracle">
     <sql splitStatements="false" endDelimiter="$">
       CREATE OR REPLACE TRIGGER TGR_SPECIMEN_REPLICATION AFTER INSERT 
       ON CATISSUE_SPECIMEN
       FOR EACH ROW
       BEGIN
 
        IF (:NEW.PARENT_SPECIMEN_ID IS NOT NULL ) THEN
         INSERT INTO CATISSUE_SPECIMEN_HIERARCHY(ANCESTOR_ID,DESCENDENT_ID) 
           (SELECT CSH.ANCESTOR_ID, :NEW.IDENTIFIER FROM CATISSUE_SPECIMEN_HIERARCHY CSH WHERE CSH.DESCENDENT_ID = :NEW.PARENT_SPECIMEN_ID);
        END IF;
  
        INSERT INTO CATISSUE_SPECIMEN_HIERARCHY(ANCESTOR_ID, DESCENDENT_ID) VALUES (:NEW.IDENTIFIER,:NEW.IDENTIFIER);

       END;
      </sql>
    </changeSet>


    <changeSet author="ajaysamgir" id="Create table CATISSUE_SITE_COORDINATORS " failOnError="true">
      <createTable tableName="CATISSUE_SITE_COORDINATORS">
        <column name="SITE_ID" type="${int.type}">
        </column>
        
        <column name="USER_ID" type="${int.type}">
        </column>
        
      </createTable>
      
      <addForeignKeyConstraint
              constraintName="FK_SITE_ID_BY_CAT_SITE_ID"
              baseTableName="CATISSUE_SITE_COORDINATORS"
              baseColumnNames="SITE_ID"
              referencedTableName="CATISSUE_SITE"
              referencedColumnNames="IDENTIFIER" />
              
      <addForeignKeyConstraint
              constraintName="FK_USER_ID_BY_CAT_USER_ID"
              baseTableName="CATISSUE_SITE_COORDINATORS"
              baseColumnNames="USER_ID"
              referencedTableName="CATISSUE_USER"
              referencedColumnNames="IDENTIFIER" />
      
    </changeSet>
   
    <changeSet author="ajaysamgir" id="Migrate CATISSUE_SITE table data to CATISSUE_SITE_COORDINATORS " failOnError="true">
      <sql>INSERT INTO CATISSUE_SITE_COORDINATORS(select Identifier,User_ID from Catissue_Site where Identifier IS NOT NULL AND USER_ID IS NOT NULL)</sql>
    </changeSet>   
        
    <changeSet author="dpatil" id="new storage container table" failOnError="true">
	   <createTable tableName="CATISSUE_STORAGE_CONTAINERS">
		 <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
		   <constraints primaryKey="true" nullable="false"/>
		 </column>

		 <column name="NAME" type="${text.type}(64)">
		     <constraints unique="true" nullable="false" />
		 </column>
		 
		 <column name="BARCODE" type="${text.type}(64)">
		 	<constraints unique="true" />
		 </column>

		 <column name="TEMPERATURE" type="${double.type}">
		 </column>
		 
		 <column name="ONE_DIMENSION_CAPACITY" type="${int.type}">
		 </column>
		 
		 <column name="TWO_DIMENSION_CAPACITY" type="${int.type}">
		 </column>
		 
		 <column name="PARENT_CONTAINER_ID" type="${int.type}">
		 </column>

		 <column name="CREATED_BY" type="${int.type}">
		   	<constraints nullable="false"/>
		 </column>
		          
		 <column name="SITE_ID" type="${int.type}">
		   	<constraints nullable="false"/>
		 </column>
		 
		 <column name="ONE_DIMENSION_LABELLING_SCHEME" type="${text.type}(64)" defaultValue="Numbers">
		 </column>
		 
		 <column name="TWO_DIMENSION_LABELLING_SCHEME" type="${text.type}(64)" defaultValue="Numbers">
		 </column>

		 <column name="ACTIVITY_STATUS" type="${text.type}(16)">
			 </column>
		 
		 <column name="COMMENTS" type="${text.type}(255)">
		 </column>
	   </createTable>
	
	   <addForeignKeyConstraint
				constraintName="FK_CAT_STOCON_USERID_USER_ID"
				baseTableName="CATISSUE_STORAGE_CONTAINERS"
				baseColumnNames="CREATED_BY"
				referencedTableName="CATISSUE_USER"
				referencedColumnNames="IDENTIFIER" />
			
	   <addForeignKeyConstraint
				constraintName="FK_CAT_STOCON_SITEID_SITE_IDs"
				baseTableName="CATISSUE_STORAGE_CONTAINERS"
				baseColumnNames="SITE_ID"
				referencedTableName="CATISSUE_SITE"
				referencedColumnNames="IDENTIFIER" />
	</changeSet>
	    
	<changeSet author="dpatil" id="holds specimen type table" failOnError="true">
	   <createTable tableName="CAT_STOR_CONT_SPEC_TYPES">
		 <column name="STORAGE_CONTAINER_ID" type="${int.type}">
		 </column>

		 <column name="SPECIMEN_TYPE" type="${text.type}(64)">
		 </column>  
	   </createTable>
	
	   <addForeignKeyConstraint
				constraintName="FK_CAT_SCST_SCID_CONTAINER_IDs"
				baseTableName="CAT_STOR_CONT_SPEC_TYPES"
				baseColumnNames="STORAGE_CONTAINER_ID"
				referencedTableName="CATISSUE_STORAGE_CONTAINERS"
				referencedColumnNames="IDENTIFIER" />
				
	</changeSet>
	    
	<changeSet author="dpatil" id="table for catissue container cp mapping" failOnError="true">
       <createTable tableName="CATISSUE_CONTAINER_CPS">
               <column name="CONTAINER_ID" type="${int.type}">
               </column>

               <column name="CP_ID" type="${int.type}">
               </column>
       </createTable>
   
       <addForeignKeyConstraint
               constraintName="FK_CAT_CC_CID_CAT_SC_ID"
               baseTableName="CATISSUE_CONTAINER_CPS"
               baseColumnNames="CONTAINER_ID"
               referencedTableName="CATISSUE_STORAGE_CONTAINERS"
               referencedColumnNames="IDENTIFIER" />
       <addForeignKeyConstraint
               constraintName="FK_CAT_CC_CPID_CAT_CP_ID"
               baseTableName="CATISSUE_CONTAINER_CPS"
               baseColumnNames="CP_ID"
               referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
               referencedColumnNames="IDENTIFIER" />
    </changeSet> 
    
   <changeSet author="ajaysamgir" id="table for distribution_protocol" failOnError="true">
       <createTable tableName="OS_DISTRIBUTION_PROTOCOL">
    	 
    	 <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
          	<constraints primaryKey="true" nullable="false"/>
        </column>
         
         <column name="PRINCIPAL_INVESTIGATOR_ID" type="${int.type}">
         </column>
         
         <column name="TITLE" type="${text.type}(255)">
         </column>
         
          <column name="SHORT_TITLE" type="${text.type}(255)">
         </column>
         
         <column name="ACTIVITY_STATUS" type="${text.type}(30)">
         </column>
         
         <column name="IRB_IDENTIFIER" type="${text.type}(255)">
         </column>
         
         <column name="START_DATE" type="${date.type}">
         </column>
         
         <column name="ANTICIPATED_SPECIMEN_COUNT" type="${int.type}">
         </column>
         
         <column name="DESCRIPTION_URL" type="${text.type}(255)">
         </column>
     
        </createTable>
 
        <addForeignKeyConstraint
               constraintName="FK_PI_ID_BY_CAT_USER_ID"
               baseTableName="OS_DISTRIBUTION_PROTOCOL"
               baseColumnNames="PRINCIPAL_INVESTIGATOR_ID"
               referencedTableName="CATISSUE_USER"
               referencedColumnNames="IDENTIFIER" />
      
    </changeSet>
       
    <changeSet author="ajaysamgir" id="adding dp sequence" failOnError="true" dbms="oracle">
	 <createSequence 
		sequenceName="OS_DISTRIBUTION_PROTOCOL_SEQ" 
		startValue="1" 
		incrementBy="1" 
		ordered="true" />
    </changeSet>
 
     <changeSet author="ajaysamgir" id="Migrate CATISSUE_D_P table data to OS_D_P table for mysql" failOnError="true" dbms="mysql">
         <sql> insert into OS_DISTRIBUTION_PROTOCOL(PRINCIPAL_INVESTIGATOR_ID, TITLE, SHORT_TITLE, IRB_IDENTIFIER, START_DATE, DESCRIPTION_URL, ACTIVITY_STATUS) 
         select PRINCIPAL_INVESTIGATOR_ID, TITLE, SHORT_TITLE, IRB_IDENTIFIER, START_DATE, DESCRIPTION_URL, ACTIVITY_STATUS from CATISSUE_DISTRIBUTION_PROTOCOL 
 		</sql>
    </changeSet> 
    
     <changeSet author="ajaysamgir" id="Migrate CATISSUE_D_P table data to OS_D_P table for oracle" failOnError="true" dbms="oracle">
         <sql> insert into OS_DISTRIBUTION_PROTOCOL(IDENTIFIER,PRINCIPAL_INVESTIGATOR_ID, TITLE, SHORT_TITLE, IRB_IDENTIFIER, START_DATE, DESCRIPTION_URL, ACTIVITY_STATUS) 
         select OS_DISTRIBUTION_PROTOCOL_SEQ.nextVal,PRINCIPAL_INVESTIGATOR_ID, TITLE, SHORT_TITLE, IRB_IDENTIFIER, START_DATE, DESCRIPTION_URL, ACTIVITY_STATUS from CATISSUE_DISTRIBUTION_PROTOCOL 
 		</sql>
 		
    </changeSet>
     
     <changeSet author="dpatil" id="new specimen print rule table" failOnError="true">
	   <createTable tableName="OS_SPECIMEN_PRINT_RULE">
		 <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
		   <constraints primaryKey="true" nullable="false"/>
		 </column>

		 <column name="NAME" type="${text.type}(255)">
		     <constraints unique="true" nullable="false" />
		 </column>
		 
		 <column name="SPECIMEN_CLASS" type="${text.type}(255)" defaultValue="Any">
		 </column>

		 <column name="SPECIMEN_TYPE" type="${text.type}(255)" defaultValue="Any">
		 </column>
		 
		 <column name="LABEL_TYPE" type="${text.type}(255)" >
		 	<constraints nullable="false"/>
		 </column>
		 
		 <column name="PRINTER_NAME" type="${text.type}(255)">
		 	<constraints nullable="false"/>
		 </column>

		 <column name="WORKSTATION_IP" type="${text.type}(64)" defaultValue="Any">
		 </column>
		 
		 <column name="LOGIN_NAME" type="${text.type}(255)" defaultValue="Any">
		 </column>
		 
		 <column name="CP_SHORT_TITLE" type="${text.type}(255)" defaultValue="Any">
		 </column>
		 
	   </createTable>
	   
	   <!--  <addUniqueConstraint constraintName="SPEC_CLASS_TYPE_ID_UNIQUE_KEY"
			tableName="OS_SPECIMEN_PRINT_RULE" columnNames="SPECIMEN_CLASS,SPECIMEN_TYPE,WORKSTATION_IP,LOGIN_NAME,CP_SHORT_TITLE" />-->
	   
	</changeSet>

	<changeSet author="dpatil" id="printrule" failOnError="true" dbms="oracle">
	 <createSequence
            sequenceName="OS_PRINT_RULE_SEQ"
            startValue="1"
            incrementBy="1"
            ordered="true" />
	</changeSet>
	
	 <changeSet author="ajaysamgir" id="Create table CATISSUE_SPECIMEN_PRINT_DATA " failOnError="true">
      <createTable tableName="CATISSUE_SPECIMEN_PRINT_DATA">
        <column name="PRINT_RULE_ID" type="${int.type}">
        </column>
        
        <column name="DATA_ON_LABEL" type="${text.type}(255)">
        </column>
        
      </createTable>
      
      <addForeignKeyConstraint
              constraintName="FK_SPEC_PRINT_ID_BY_PRINT_RULE"
              baseTableName="CATISSUE_SPECIMEN_PRINT_DATA"
              baseColumnNames="PRINT_RULE_ID"
              referencedTableName="OS_SPECIMEN_PRINT_RULE"
              referencedColumnNames="IDENTIFIER" />
               
    </changeSet>

    <changeSet id="Create SPECIMEN_ORDER_VIEW" author="mibrahim" runOnChange="true" dbms="mysql">
       <sql>CREATE OR REPLACE VIEW SPECIMEN_ORDER_VIEW AS 

		(SELECT SPORDITM.SPECIMEN_ID AS SPECIMEN_ID, ORDITM.ORDER_ID AS ORDER_ID
		FROM CATISSUE_EXISTING_SP_ORD_ITEM SPORDITM JOIN CATISSUE_ORDER_ITEM ORDITM 
		ON SPORDITM.IDENTIFIER = ORDITM.IDENTIFIER)

		UNION DISTINCT 

		(SELECT SPARRYCNT.SPECIMEN_ID AS SPECIMEN_ID, ORDITM.ORDER_ID AS ORDER_ID
		FROM CATISSUE_EXIST_SP_AR_ORD_ITEM SPARORDITM JOIN CATISSUE_SPECIMEN_ARRAY SPARRAY 
		ON SPARORDITM.SPECIMEN_ARRAY_ID = SPARRAY.IDENTIFIER JOIN 
		CATISSUE_SPECI_ARRAY_CONTENT SPARRYCNT ON SPARRAY.IDENTIFIER = SPARRYCNT.SPECIMEN_ARRAY_ID 
		JOIN CATISSUE_ORDER_ITEM ORDITM ON SPARORDITM.IDENTIFIER = ORDITM.IDENTIFIER) 
	</sql>
     </changeSet>

    <changeSet id="Create SPECIMEN_ORDER_VIEW" author="mibrahim" runOnChange="true" dbms="oracle">
       <sql>CREATE OR REPLACE VIEW SPECIMEN_ORDER_VIEW AS 

		(SELECT SPORDITM.SPECIMEN_ID AS SPECIMEN_ID, ORDITM.ORDER_ID AS ORDER_ID
		FROM CATISSUE_EXISTING_SP_ORD_ITEM SPORDITM JOIN CATISSUE_ORDER_ITEM ORDITM 
		ON SPORDITM.IDENTIFIER = ORDITM.IDENTIFIER)

		UNION  

		(SELECT SPARRYCNT.SPECIMEN_ID AS SPECIMEN_ID, ORDITM.ORDER_ID AS ORDER_ID
		FROM CATISSUE_EXIST_SP_AR_ORD_ITEM SPARORDITM JOIN CATISSUE_SPECIMEN_ARRAY SPARRAY 
		ON SPARORDITM.SPECIMEN_ARRAY_ID = SPARRAY.IDENTIFIER JOIN 
		CATISSUE_SPECI_ARRAY_CONTENT SPARRYCNT ON SPARRAY.IDENTIFIER = SPARRYCNT.SPECIMEN_ARRAY_ID 
		JOIN CATISSUE_ORDER_ITEM ORDITM ON SPARORDITM.IDENTIFIER = ORDITM.IDENTIFIER) 
	</sql>
     </changeSet>

    <changeSet id="Create SPECIMEN_SHIPMENT_VIEW" author="mibrahim" runOnChange="true" dbms="mysql">
       <sql>CREATE OR REPLACE VIEW SPECIMEN_SHIPMENT_VIEW AS 
		(SELECT CSRR.SPECIMEN_ID AS SPECIMEN_ID, CSRR.SHIPMENT_REQ_ID AS SHIPMENT_ID 
		FROM CATISSUE_SPECI_SHIPMNT_REQ_REL CSRR)

		UNION DISTINCT

		(SELECT CSP.SPECIMEN_ID AS SPECIMEN_ID , CSCR.BASE_SHIPMENT_ID AS SHIPMENT_ID FROM
		CATISSUE_CONTAINER CTR JOIN CATISSUE_SPECIMEN_POSITION CSP ON CTR.IDENTIFIER = CSP.CONTAINER_ID JOIN
		CATISSUE_SHIPMENT_CONTAINR_REL CSCR ON CTR.IDENTIFIER = CSCR.CONTAINER_ID) 
	</sql>
	<sql>commit;</sql>
     </changeSet>

    <changeSet id="Create SPECIMEN_SHIPMENT_VIEW" author="mibrahim" runOnChange="true" dbms="oracle">
       <sql>CREATE OR REPLACE VIEW SPECIMEN_SHIPMENT_VIEW AS 
		(SELECT CSRR.SPECIMEN_ID AS SPECIMEN_ID, CSRR.SHIPMENT_REQ_ID AS SHIPMENT_ID 
		FROM CATISSUE_SPECI_SHIPMNT_REQ_REL CSRR)

		UNION

		(SELECT CSP.SPECIMEN_ID AS SPECIMEN_ID , CSCR.BASE_SHIPMENT_ID AS SHIPMENT_ID FROM
		CATISSUE_CONTAINER CTR JOIN CATISSUE_SPECIMEN_POSITION CSP ON CTR.IDENTIFIER = CSP.CONTAINER_ID JOIN
		CATISSUE_SHIPMENT_CONTAINR_REL CSCR ON CTR.IDENTIFIER = CSCR.CONTAINER_ID) 
	</sql>
	<sql>commit;</sql>
    </changeSet>

    <changeSet id="CPR_VIEW INCLUDING PARTICIPANT MIDDLE_NAME AND CONSENT_DOC_URL" author="mibrahim" failOnError="true">
        <sql>CREATE OR REPLACE VIEW cpr_view AS 

            (select cpr.IDENTIFIER AS CPR_ID,cpr.COLLECTION_PROTOCOL_ID AS CP_ID, cpr.PARTICIPANT_ID AS PARTICIPANT_ID,
            p.FIRST_NAME AS FIRST_NAME,p.MIDDLE_NAME AS MIDDLE_NAME,p.LAST_NAME AS LAST_NAME,p.BIRTH_DATE AS DOB,
            p.SOCIAL_SECURITY_NUMBER AS SSN,cpr.ACTIVITY_STATUS AS ACTIVITY_STATUS,p.GENDER AS GENDER,
            p.GENOTYPE AS GENOTYPE,cpr.REGISTRATION_DATE AS REGISTRATION_DATE,cpr.PROTOCOL_PARTICIPANT_ID AS PPID,
            p.VITAL_STATUS AS VITAL_STATUS,p.DEATH_DATE AS DEATH_DATE,p.ETHNICITY AS ETHNICITY,
            cpr.BARCODE AS BARCODE,cpr.CONSENT_SIGN_DATE AS CONSENT_SIGN_DATE,cpr.CONSENT_WITNESS AS CONSENT_WITNESS,
            cpr.CONSENT_DOC_URL as CONSENT_DOC_URL 
            from (catissue_coll_prot_reg cpr join catissue_participant p on((cpr.PARTICIPANT_ID = p.IDENTIFIER))));
        </sql>
    </changeSet>
    
    <changeSet author="vpawar" id="Add column to soft delete a query" dbms="mysql">
      <sql>alter table CATISSUE_SAVED_QUERIES add column DELETED_ON TIMESTAMP NULL DEFAULT NULL</sql>
    </changeSet>

    <changeSet author="vpawar" id="Add column to soft delete a query" dbms="oracle">
      <sql>alter table CATISSUE_SAVED_QUERIES add DELETED_ON TIMESTAMP DEFAULT NULL</sql>
    </changeSet>

    <changeSet author="vpawar" id="Index column used to indicate soft delete of query">
      <createIndex 
        indexName="IDX_QUERY_DELETED_ON"
        tableName="CATISSUE_SAVED_QUERIES"
        unique="false">
        <column name="DELETED_ON" type="${timestamp.type}"/>
      </createIndex>
    </changeSet>

    <changeSet author="vpawar" id="Add auto increment to specimen lists table" dbms="mysql">
      <sql>
        select IFNULL(max(IDENTIFIER), 0) + 1 INTO @max_list_id from CATISSUE_SPECIMENLIST_TAGS;
        set @sql = 'alter table CATISSUE_SPECIMENLIST_TAGS modify column IDENTIFIER BIGINT AUTO_INCREMENT';
        prepare stmt from @sql;
        execute stmt;
        deallocate prepare stmt;

        set @sql = concat('alter table CATISSUE_SPECIMENLIST_TAGS AUTO_INCREMENT = ', @max_list_id);
        prepare stmt from @sql;
        execute stmt;
        deallocate prepare stmt;
      </sql>
    </changeSet>

    <changeSet author="vpawar" id="Add sequence to specimen lists table" dbms="oracle">
      <sql splitStatements="false">
        DECLARE
          max_list_id number := 1;
          sql_stmt varchar2(255);
        BEGIN
          select nvl(max(IDENTIFIER), 0) + 1 into max_list_id from CATISSUE_SPECIMENLIST_TAGS;
          sql_stmt := 'create sequence CATISSUE_SPECIMEN_LIST_SEQ start with ' || max_list_id ;
          execute immediate sql_stmt;
        END;
      </sql>
    </changeSet>

    <changeSet author="vpawar" id="Drop unwanted identifier column">
      <dropColumn tableName="CATISSUE_SPEC_TAG_ITEMS" columnName="IDENTIFIER"/>
    </changeSet>

     <changeSet id="Create PART_MED_REC_VIEW" author="mibrahim" runOnChange="true">
       <sql>CREATE OR REPLACE VIEW PART_MED_REC_VIEW AS 
		(SELECT PARTMEDID.IDENTIFIER AS IDENTIFIER, SITE.NAME AS SITE_NAME,  
		PARTMEDID.PARTICIPANT_ID AS PARTICIPANT_ID, PARTMEDID.MEDICAL_RECORD_NUMBER AS MEDICAL_RECORD_NUMBER  FROM 
		CATISSUE_PART_MEDICAL_ID PARTMEDID JOIN CATISSUE_SITE SITE ON PARTMEDID.SITE_ID = SITE.IDENTIFIER)
	</sql>
     </changeSet>

     <changeSet id="Create CONSENT_TIER_VIEW" author="mibrahim" runOnChange="true">
       <sql>CREATE OR REPLACE VIEW CONSENT_TIER_VIEW AS
		(SELECT CNSSTMT.IDENTIFIER AS IDENTIFIER, CNSRSP.COLL_PROT_REG_ID AS CPR_ID,
		CNSSTMT.STATEMENT AS STATEMENT, CNSRSP.RESPONSE AS RESPONSE
		FROM CATISSUE_CONSENT_TIER CNSSTMT INNER JOIN 
		CATISSUE_CONSENT_TIER_RESPONSE CNSRSP ON CNSSTMT.IDENTIFIER = CNSRSP.CONSENT_TIER_ID 
		WHERE CNSRSP.COLL_PROT_REG_ID IS NOT NULL)
	</sql>
     </changeSet>

	<changeSet id="CATISSUE_PERMISSIBLE_VALUE'S FOR ORDER_STATUS" author="mibrahim" failOnError="true"  dbms="mysql" >
		<sql>INSERT INTO CATISSUE_CDE VALUES ( 'order_status','Order Status','Order Status',1.0,null)</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('New',NULL,'order_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Completed',NULL,'order_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Pending',NULL,'order_status')</sql>
	</changeSet>

 	<changeSet id="CATISSUE_PERMISSIBLE_VALUE'S FOR ORDER_STATUS" author="mibrahim" failOnError="true"  dbms="oracle" >
		<sql>INSERT INTO CATISSUE_CDE VALUES ( 'order_status','Order Status','Order Status',1.0,null)</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'New',NULL,'order_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Completed',NULL,'order_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Pending',NULL,'order_status')</sql>
	</changeSet>


	<changeSet id="CATISSUE_PERMISSIBLE_VALUE'S FOR SHIPPING_ACTIVITY_STATUS" author="mibrahim" failOnError="true"  dbms="mysql" >
		<sql>INSERT INTO CATISSUE_CDE VALUES ( 'shipping_activity_status','Shipping Activity Status','Shipping Activity Status',1.0,null)</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Processed',NULL,'shipping_activity_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Received',NULL,'shipping_activity_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('In Transit',NULL,'shipping_activity_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('In Progress',NULL,'shipping_activity_status')</sql>
	</changeSet>

 	<changeSet id="CATISSUE_PERMISSIBLE_VALUE'S FOR SHIPPING_ACTIVITY_STATUS" author="mibrahim" failOnError="true"  dbms="oracle" >
		<sql>INSERT INTO CATISSUE_CDE VALUES ( 'shipping_activity_status','Shipping Activity Status','Shipping Activity Status',1.0,null)</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Processed',NULL,'shipping_activity_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Received',NULL,'shipping_activity_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'In Transit',NULL,'shipping_activity_status')</sql>
		<sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'In Progress',NULL,'shipping_activity_status')</sql>
	</changeSet>

     <changeSet author="dpatil" id="add activity status column to catissue_institution table" failOnError="true">
        <addColumn tableName="catissue_institution">
        <column name="ACTIVITY_STATUS" type="${text.type}(64)" defaultValue="Active"/>
        </addColumn>
    </changeSet>
   
    <changeSet author="dpatil" id="migrate user table for open specimen" failOnError="true">
       <sql>
            create table os_user as select * from catissue_user
       </sql>
    </changeSet>
   
    <changeSet author="dpatil" id="migrate database table for open specimen" failOnError="true">
       <sql>
            create table os_department as select * from catissue_department
       </sql>
    </changeSet>

    <changeSet author="dpatil" id="add columns in os department tables" failOnError="true">   
    <addColumn tableName="OS_DEPARTMENT">
         <column name="INSTITUTE_ID" type="${int.type}"/>
        </addColumn>
   
    <addColumn tableName="OS_DEPARTMENT">
        <column name="ACTIVITY_STATUS" type="${text.type}(64)" defaultValue="Active"/>
        </addColumn>
     </changeSet>
        
    <changeSet author="dpatil" id="data migration os department table" failOnError="false" dbms="mysql" >
    <sql>
         UPDATE OS_DEPARTMENT dept JOIN os_user usr ON usr.department_id = dept.identifier SET  dept.institute_id = usr.institution_id WHERE usr.institution_id IS NOT NULL
    </sql>
    </changeSet>

    <!--<changeSet author="dpatil" id="data migration for inst in new department" failOnError="true" dbms="oracle" >
      <sql splitStatements="false" endDelimiter="$">
        create or replace  
            PROCEDURE MIGRATE_INSTITUTE_PROC 
            IS
               deptId number;
               instId number;
           
            BEGIN 
            for d in (Select usr.institution_id AS instId, usr.department_id As deptId from os_user usr JOIN OS_DEPARTMENT dept ON usr.department_id = dept.identifier WHERE usr.institution_id IS NOT NULL)
               loop
                UPDATE catissue_department SET institute_id = d.instId WHERE identifier= d.deptId;
               end loop;
            commit; 
            END MIGRATE_INSTITUTE_PROC;
    </sql>
    <sql>call MIGRATE_INSTITUTE_PROC();</sql>   
    </changeSet> -->

    <changeSet author="dpatil" id="add unique constraints columns in os_department table" failOnError="true">
          <addUniqueConstraint constraintName="OS_DEPT_INSTID_UNIQUE_KEY"
            tableName="OS_DEPARTMENT" columnNames="NAME, INSTITUTE_ID" />
    </changeSet>   
   
   <changeSet author="dpatil" id="sequence generation for user and department" dbms="oracle" failOnError="true">
        <sql endDelimiter="/">
        BEGIN
        DECLARE
            userId NUMBER;
            deptId NUMBER;
        BEGIN
              SELECT NVL(MAX(IDENTIFIER),0)+1
              INTO userId
              FROM OS_USER;
             
              SELECT NVL(MAX(IDENTIFIER),0)+1
              INTO deptId
              FROM OS_DEPARTMENT;
             
              execute immediate('CREATE SEQUENCE OS_USER_SEQ MINVALUE 0 START WITH '||userId||' INCREMENT BY 1 NOCACHE');
              execute immediate('CREATE SEQUENCE OS_DEPARTMENT_SEQ MINVALUE 0 START WITH '||deptId||' INCREMENT BY 1 NOCACHE');
        END;
        END;
        /
        </sql>
   </changeSet>

   <changeSet author="dpatil" id="add primary keys" failOnError="true" dbms="mysql">
    <sql> ALTER table os_department modify column IDENTIFIER BIGINT(20)primary key not null auto_increment</sql>
    <sql> ALTER table os_user modify column IDENTIFIER BIGINT(20)primary key not null auto_increment</sql>
   </changeSet>   
 
   <changeSet author="dpatil" id="add primary keys" failOnError="true" dbms="oracle">
    <sql>ALTER TABLE os_user ADD CONSTRAINT pk_user_id PRIMARY KEY (identifier)</sql>
    <sql>ALTER TABLE os_department ADD CONSTRAINT pk_department_id PRIMARY KEY (identifier)</sql>
   </changeSet>   

   <changeSet author="dpatil" id="add constraints" failOnError="true">
    <addForeignKeyConstraint
            constraintName="FK_OS_USRDEPTID_DEPT_ID"
            baseTableName="OS_USER"
            baseColumnNames="DEPARTMENT_ID"
            referencedTableName="OS_DEPARTMENT"
            referencedColumnNames="IDENTIFIER" />

    <addForeignKeyConstraint
            constraintName="FK_OS_USRADDID_ADD_ID"
            baseTableName="OS_USER"
            baseColumnNames="ADDRESS_ID"
            referencedTableName="CATISSUE_ADDRESS"
            referencedColumnNames="IDENTIFIER" />

    <addForeignKeyConstraint
            constraintName="FK_OS_DEPTINSTID_INST_ID"
            baseTableName="OS_DEPARTMENT"
            baseColumnNames="INSTITUTE_ID"
            referencedTableName="CATISSUE_INSTITUTION"
            referencedColumnNames="IDENTIFIER" />
   </changeSet>

  <changeSet id="CREATE USER_VIEW" author="mibrahim" failOnError="true" runOnChange="true">
    <sql>
      CREATE OR REPLACE VIEW USER_VIEW AS (
        SELECT U.IDENTIFIER AS IDENTIFIER, U.FIRST_NAME AS FIRST_NAME, 
        U.LAST_NAME AS LAST_NAME, U.EMAIL_ADDRESS AS EMAIL_ADDRESS, D.NAME AS DEPARTMENT_NAME 
      FROM 
        CATISSUE_USER U JOIN CATISSUE_DEPARTMENT D ON U.DEPARTMENT_ID = D.IDENTIFIER
      )
    </sql>
  </changeSet>    
  
  <changeSet id="adding identified deIdentified report column in scg" author="dpatil" runOnChange="true">
    <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
       <column name="IDENTIFIED_REPORT" type="${clob.type}"/>
    </addColumn>	
        
    <addColumn tableName="CATISSUE_SPECIMEN_COLL_GROUP">
       <column name="DEIDENTIFIED_REPORT" type="${clob.type}"/>
    </addColumn>	   
   </changeSet>
   
   <changeSet id="add foreign key constraint in catissue_distri_event_param" author="nitesh" failOnError="false">
		<preConditions  onFail="MARK_RAN">
			<tableExists  tableName="catissue_distri_event_param" />
		</preConditions>
        <addForeignKeyConstraint
            constraintName="FK_SP_DISTRI_SP_EVENT"
            baseTableName="CATISSUE_DISTRI_EVENT_PARAM"
            baseColumnNames="SPECIMEN_ID"
            referencedTableName="CATISSUE_SPECIMEN"
            referencedColumnNames="IDENTIFIER" />
        <addForeignKeyConstraint
            constraintName="FK_DISTRI_DISTRI_SP_EVENT"
            baseTableName="CATISSUE_DISTRI_EVENT_PARAM"
            baseColumnNames="DISTRIBUTION_ID"
            referencedTableName="CATISSUE_DISTRIBUTION"
            referencedColumnNames="IDENTIFIER" />
  </changeSet>    
  
  <changeSet id="migrating distribution event data" author="nitesh" dbms="mysql">
		<preConditions  onFail="MARK_RAN">
			<tableExists  tableName="CATISSUE_DISTRI_EVENT_PARAM" />
		</preConditions>
        <sql>DROP PROCEDURE IF EXISTS  migrateDistriData;</sql>
        <sql splitStatements="false">
            CREATE PROCEDURE migrateDistriData()
            BEGIN
            declare qty double;
            declare dist_id bigint;
            declare event_time dateTime default '2013-05-03 06:40:37';
            declare specimen_id bigint;
            declare user_id bigint;
            declare comments text;
            declare nextId bigint;
            declare record_not_found integer default 0;
            
            DECLARE distri cursor for select COIT.Requested_Quantity, CD.Identifier, CD.Event_TimeStamp, CESOI.SPECIMEN_ID, CD.User_Id, CD.Comments
                from CATISSUE_ORDER_ITEM COIT join CATISSUE_EXISTING_SP_ORD_ITEM CESOI ON CESOI.IDENTIFIER =  COIT.IDENTIFIER
                join catissue_distribution CD on CD.order_Id = COIT.order_Id 
                left join catissue_distri_event_param cdep on CD.identifier = cdep.distribution_id
                WHERE CESOI.SPECIMEN_ID IS NOT NULL AND (COIT.STATUS = 'Distributed' OR COIT.STATUS = 'Distributed And Close')
                and cdep.distribution_id is null;
                
            declare CONTINUE HANDLER for NOT FOUND SET record_not_found = 1;

            open distri;
            read_loop: LOOP
                fetch distri into qty, dist_id, event_time, specimen_id, user_id, comments;
                if record_not_found then leave read_loop;
                        end if;
            SELECT max(IDENTIFIER)+1 INTO nextId from CATISSUE_SPECIMEN_EVENT_PARAM;
            INSERT INTO  CATISSUE_SPECIMEN_EVENT_PARAM(SPECIMEN_ID,EVENT_TIMESTAMP,USER_ID,COMMENTS) values(specimen_id, event_time,user_id,comments);
            INSERT INTO CATISSUE_DISTRI_EVENT_PARAM(identifier,DISTRIBUTED_QUANTITY,DISTRIBUTION_ID,EVENT_TIMESTAMP,SPECIMEN_ID,USER_ID,COMMENTS) 
            values(nextId,qty,dist_id,event_time,specimen_id,user_id,comments);
            end LOOP;
            CLOSE distri;
            END
       </sql>
       <sql>call migrateDistriData();</sql>
       <sql>commit;</sql>
  </changeSet>
  
  <changeSet id="migrating distribution event data" author="nitesh" runOnChange="true" dbms="oracle">
			<preConditions  onFail="MARK_RAN">
				<tableExists  tableName="CATISSUE_DISTRI_EVENT_PARAM" />
			</preConditions>
            <sql splitStatements="false" endDelimiter="$">
            create or replace  PROCEDURE migrateDistriData
                         IS
                         qty FLOAT;
                        dist_id number;
                        event_time date;
                        specimen_id number;
                        user_id number;
                        comments varchar2(2000);
                        nextId number;
                        
                        cursor distri IS select COIT.Requested_Quantity, CD.Identifier, CD.Event_TimeStamp, CESOI.SPECIMEN_ID, CD.User_Id, CD.Comments
                          from CATISSUE_ORDER_ITEM COIT join CATISSUE_EXISTING_SP_ORD_ITEM CESOI ON CESOI.IDENTIFIER =  COIT.IDENTIFIER
                          join catissue_distribution CD on CD.order_Id = COIT.order_Id 
                          left join catissue_distri_event_param cdep on CD.identifier = cdep.distribution_id
                          WHERE CESOI.SPECIMEN_ID IS NOT NULL AND (COIT.STATUS = 'Distributed' OR COIT.STATUS = 'Distributed And Close')
                          and cdep.distribution_id is null;
                         BEGIN
                         open distri;
                         LOOP
                             fetch distri into qty, dist_id, event_time, specimen_id, user_id, comments;
                          EXIT WHEN distri%notfound;
                           select CATISSUE_SPEC_EVENT_PARAM_SEQ.NEXTVAL into nextId from dual;
                          
                          INSERT INTO  CATISSUE_SPECIMEN_EVENT_PARAM(IDENTIFIER,SPECIMEN_ID,EVENT_TIMESTAMP,USER_ID,COMMENTS) values(nextId,specimen_id, event_time,user_id,comments);
                          INSERT INTO CATISSUE_DISTRI_EVENT_PARAM (identifier,DISTRIBUTED_QUANTITY,DISTRIBUTION_ID,EVENT_TIMESTAMP,SPECIMEN_ID,USER_ID,COMMENTS) values(nextId,qty,dist_id,event_time,specimen_id,user_id,comments);

             END LOOP;
             CLOSE distri;
             END;
           </sql>
           <sql>call migrateDistriData();</sql>
            <sql>commit;</sql>
    </changeSet>

  <changeSet id="CREATE CPR_EXTENSION_RECORDS_VIEW" author="mibrahim" failOnError="true" runOnChange="true">
    <sql>
      CREATE OR REPLACE VIEW cpr_extension_records_view AS (
        SELECT 
          re.OBJECT_ID AS cpr_id,re.RECORD_ID AS record_id 
        FROM 
          (catissue_form_record_entry re JOIN catissue_form_context fc ON((re.FORM_CTXT_ID = fc.IDENTIFIER))) 
        WHERE 
          ((fc.ENTITY_TYPE = 'Participant') AND (re.activity_status = 'ACTIVE'))
      )
    </sql>
  </changeSet>    
  

  <changeSet id="CREATE SCG_EXTN_RECORDS_VIEW" author="mibrahim" failOnError="true" runOnChange="true">
    <sql>
      CREATE OR REPLACE VIEW scg_extn_records_view AS (
        SELECT 
          re.OBJECT_ID AS scg_id,re.RECORD_ID AS record_id 
        FROM 
          (catissue_form_record_entry re JOIN catissue_form_context fc ON((fc.IDENTIFIER = re.FORM_CTXT_ID))) 
        WHERE 
          ((fc.ENTITY_TYPE = 'SpecimenCollectionGroup') AND (re.activity_status = 'ACTIVE'))
      )
    </sql>
  </changeSet>   

  <changeSet id="CREATE SPECIMEN_EXTN_RECORDS_VIEW" author="mibrahim" failOnError="true" runOnChange="true">
    <sql>
      CREATE OR REPLACE VIEW specimen_extn_records_view AS (
        SELECT 
          re.OBJECT_ID AS specimen_id,re.RECORD_ID AS record_id 
        FROM 
          (catissue_form_record_entry re JOIN catissue_form_context fc ON((fc.IDENTIFIER = re.FORM_CTXT_ID))) 
        WHERE 
          ((fc.ENTITY_TYPE = 'Specimen') AND (re.activity_status = 'ACTIVE'))
      )
    </sql>
  </changeSet>
  
  <changeSet author="nitesh" id="add unique constraint for specimen Id in coll/rec event table" failOnError="false">
    <addUniqueConstraint 
            columnNames="specimen_id"
            constraintName="UN_SPEC_ID_REC_EVENT"
            tableName="CATISSUE_RECEIVED_EVENT_PARAM"/>
     
    <addUniqueConstraint 
            columnNames="specimen_id"
            constraintName="UN_SPEC_ID_COLL_EVENT"
            tableName="CATISSUE_COLL_EVENT_PARAM"/>
  </changeSet>
  
    <changeSet author="ajaysamgir" id="cat_equipment table"
		failOnError="false">
		<createTable tableName="CATISSUE_EQUIPMENT">
			<column name="IDENTIFIER" type="${int.type}" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>

			<column name="DEVICE_NAME" type="${text.type}(255)">
				<constraints nullable="false" />
			</column>

			<column name="DEVICE_SER_NUMBER" type="${text.type}(50)">
			</column>

			<column name="MANUFACTURER_NAME" type="${text.type}(255)">
			</column>

			<column name="SOFTWARE_VERSION" type="${text.type}(50)">
			</column>

			<column name="SITE_ID" type="${int.type}(20)">
			</column>

			<column name="EQUIPMENT_ID" type="${text.type}(100)">
				<constraints nullable="false" />
			</column>

			<column name="DISPLAY_NAME" type="${text.type}(100)">
				<constraints nullable="false" />
			</column>
			
			<column name="ACTIVITY_STATUS" type="${text.type}(20)">
			</column>
		</createTable>
		
		<addForeignKeyConstraint 
			constraintName="FK_EQUPT_SITE_ID"
			baseTableName="CATISSUE_EQUIPMENT" 
			baseColumnNames="SITE_ID"
			referencedTableName="CATISSUE_SITE" 
			referencedColumnNames="IDENTIFIER" />
		<addUniqueConstraint 
			constraintName="EQPT_ID_UNIQUE_KEY"
			tableName="CATISSUE_EQUIPMENT" 
			columnNames="EQUIPMENT_ID" />

	</changeSet>

	<changeSet author="ajaysamgir" id="adding equipament sequence" failOnError="true" dbms="oracle">
		<createSequence 
			sequenceName="CAT_EQP_SEQ" 
			startValue="1" 
			incrementBy="1" 
			ordered="true" />
    </changeSet>
	
	<changeSet author="ajaysamgir" id="alter CATISSUE_EQUIPMENT table"	failOnError="false">
		<addColumn tableName="CATISSUE_EQUIPMENT">
			<column name="ACTIVITY_STATUS" type="${text.type}(20)" />
		</addColumn>
	</changeSet>
	
	<changeSet author="ajaysamgir" id="CATISSUE_IMAGE table"
		failOnError="false">
		<createTable tableName="CATISSUE_IMAGE">

			<column name="IDENTIFIER" type="${int.type}" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>

			<column name="DESCRIPTION" type="${text.type}(1000)">
			</column>

			<column name="EQP_IMAGE_ID" type="${text.type}(100)">
				<constraints nullable="false" />
			</column>

			<column name="HEIGHT" type="${int.type}(1000)">
			</column>

			<column name="LAST_UPDATE_DATE" type="${date.type}">
			</column>

			<column name="QUALITY" type="${int.type}(50)">
			</column>

			<column name="RESOLUTION" type="${text.type}(50)">
			</column>

			<column name="SCAN_DATE" type="${date.type}">
			</column>

			<column name="STAIN_NAME" type="${text.type}(500)">
			</column>

			<column name="STATUS" type="${text.type}(55)">
			</column>

			<column name="THUMBNAIL" type="${blob.type}">
			</column>

			<column name="WIDTH" type="${int.type}(10)">
			</column>

			<column name="IMAGE_TYPE" type="${text.type}(100)">
			</column>

			<column name="EQUIPMENT_ID" type="${int.type}(100)">
				<constraints nullable="false" />
			</column>

			<column name="SPECIMEN_ID" type="${int.type}(10)">
				<constraints nullable="false" />
			</column>

			<column name="FULL_LOC_URL" type="${text.type}(200)">
			</column>

			<column name="ACTIVITY_STATUS" type="${text.type}(20)">
			</column>

		</createTable>
		
		
			
		<addForeignKeyConstraint 
			constraintName="FK_CAT_IMGE_SPECIMEN_ID"
			baseTableName="CATISSUE_IMAGE" 
			baseColumnNames="SPECIMEN_ID"
			referencedTableName="CATISSUE_SPECIMEN" 
			referencedColumnNames="IDENTIFIER" />

		<addForeignKeyConstraint 
			constraintName="FK_CAT_IMGE_EQUIPMENT_ID"
			baseTableName="CATISSUE_IMAGE" 
			baseColumnNames="EQUIPMENT_ID"
			referencedTableName="CATISSUE_EQUIPMENT" 
			referencedColumnNames="IDENTIFIER" />

		<addUniqueConstraint 
			constraintName="EQPT_IMGE_ID_UNIQUE_KEY"
			tableName="CATISSUE_IMAGE" 
			columnNames="EQUIPMENT_ID,EQP_IMAGE_ID" />
	</changeSet>

	<changeSet author="ajaysamgir" id="adding image sequence" failOnError="true" dbms="oracle">
		<createSequence 
			sequenceName="CAT_IMG_SEQ" 
			startValue="1" 
			incrementBy="1" 
			ordered="true" />
    </changeSet>

   <changeSet author="vpawar" id="Table to track changes in default imported queries">
     <createTable tableName="CATISSUE_IMPORT_QUERIES_LOG">
       <column name="FILENAME" type="${text.type}(255)">
         <constraints nullable="false"/>
       </column>
       <column name="MD5_DIGEST" type="${text.type}(64)">
         <constraints nullable="false"/>
       </column>
       <column name="STATUS" type="${text.type}(16)">
         <constraints nullable="false"/>
       </column>
       <column name="EXECUTED_ON" type="${timestamp.type}">
         <constraints nullable="false"/>
       </column>
       <column name="QUERY_ID" type="${int.type}">
         <constraints nullable="false"/>
       </column>
     </createTable>
   </changeSet>

   <changeSet author="mibrahim" id="CP Coordinators view" runOnChange="true">
     <sql>
       CREATE OR REPLACE VIEW CP_COORD_VIEW AS(
         SELECT
           U.IDENTIFIER AS IDENTIFIER, U.FIRST_NAME AS FIRST_NAME, U.LAST_NAME AS LAST_NAME,
           U.EMAIL_ADDRESS AS EMAIL_ADDRESS, CPCRD.COLLECTION_PROTOCOL_ID AS CP_ID , D.NAME AS DEPARTMENT_NAME
         FROM
           CATISSUE_COLL_COORDINATORS CPCRD
           INNER JOIN CATISSUE_USER U ON CPCRD.USER_ID = U.IDENTIFIER
           INNER JOIN CATISSUE_DEPARTMENT D ON U.DEPARTMENT_ID = D.IDENTIFIER
       );
     </sql>
   </changeSet>

   <changeSet author="mibrahim" id="Specimen Hazard View" runOnChange="true">
     <sql>
       CREATE OR REPLACE VIEW SPECIMEN_BIOHAZARD_VIEW AS (
         SELECT
           BHZ.IDENTIFIER AS IDENTIFIER, BHZREL.SPECIMEN_ID AS SPECIMEN_ID,
           BHZ.NAME AS BIOHAZARD_NAME, BHZ.TYPE AS BIOHAZARD_TYPE
         FROM
           CATISSUE_SPECIMEN_BIOHZ_REL BHZREL
           INNER JOIN CATISSUE_BIOHAZARD BHZ ON BHZREL.BIOHAZARD_ID = BHZ.IDENTIFIER
       );
     </sql>
   </changeSet>

   <changeSet author="mibrahim" id="Order site view" runOnChange="true">
     <sql>
       CREATE OR REPLACE VIEW ORDER_SITE_VIEW AS (
         SELECT
           DISTB.IDENTIFIER AS IDENTIFIER, SITE.NAME AS SITE_NAME, DISTB.ORDER_ID
         FROM
           CATISSUE_DISTRIBUTION DISTB
           INNER JOIN CATISSUE_SITE SITE ON DISTB.TO_SITE_ID = SITE.IDENTIFIER
         WHERE
           DISTB.ORDER_ID IS NOT NULL
       );
     </sql>
   </changeSet>

   <changeSet author="mibrahim" id="Shipment view" runOnChange="true">
     <sql>
       CREATE OR REPLACE VIEW SHIPMENT_BASE_VIEW AS (
         SELECT
           BSHP.IDENTIFIER AS IDENTIFIER, BSHP.LABEL AS LABEL, BSHP.SENDER_SITE_ID AS SENDER_SITE_ID,
           BSHP.SENDER_USER_ID AS SENDER_USER_ID, BSHP.SEND_DATE AS SEND_DATE, BSHP.SENDER_COMMENTS AS SENDER_COMMENTS,
           BSHP.RECEIVER_COMMENTS AS RECEIVER_COMMENTS, BSHP.ACTIVITY_STATUS AS ACTIVITY_STATUS, SHP.BARCODE AS BARCODE,
           BSHP.RECEIVER_SITE_ID AS RECEIVER_SITE_ID
         FROM
           CATISSUE_BASE_SHIPMENT BSHP
           LEFT JOIN CATISSUE_SHIPMENT SHP ON BSHP.IDENTIFIER = SHP.IDENTIFIER
       );
     </sql>
   </changeSet>

   <changeSet author="mibrahim" id="Specimen position view" runOnChange="true">
     <sql>
       CREATE OR REPLACE VIEW SPECIMEN_POS_VIEW AS (
         SELECT
           SPPOS.IDENTIFIER AS IDENTIFIER, SPPOS.SPECIMEN_ID AS SPECIMEN_ID,
           CONTAINER.NAME AS CONTAINER_NAME, ABP.POSITION_DIMENSION_ONE_STRING AS POSITION_DIMENSION_ONE_STRING,
           ABP.POSITION_DIMENSION_TWO_STRING AS POSITION_DIMENSION_TWO_STRING
         FROM
           CATISSUE_SPECIMEN_POSITION SPPOS
           INNER JOIN CATISSUE_CONTAINER CONTAINER ON SPPOS.CONTAINER_ID = CONTAINER.IDENTIFIER
           INNER JOIN CATISSUE_ABSTRACT_POSITION ABP ON SPPOS.IDENTIFIER = ABP.IDENTIFIER
       );
     </sql>
     
   </changeSet>
   
    <changeSet author="ajaysamgir" id="alter table catissue_biohazard" failOnError="true">
 		<addColumn tableName="CATISSUE_BIOHAZARD">
			<column name="ACTIVITY_STATUS" type="${text.type}(20)" />
		</addColumn>
   </changeSet> 

  <changeSet author="vpawar" id="Column to specify a folder is shared with all users">
    <addColumn tableName="CATISSUE_QUERY_FOLDERS">
      <column name="SHARED_WITH_ALL" type="${boolean.type}"> </column>
    </addColumn>
  </changeSet>

   
</databaseChangeLog>
